{{- if .Values.sysfunction.grafana.enabled }}
apiVersion: nuclio.io/v1beta1
kind: NuclioFunction
metadata:
  labels:
    nuclio.io/project-name: grafana
  name: nodejs-grafana-connector
  namespace: sys
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
spec:
  alias: latest
  build:
    codeEntryType: sourceCode
    commands:
    - npm install --global moment
    - npm install --global jsonwebtoken
    - npm install --global axios
    - npm install --global jwks-rsa
    - npm install --global randomstring
    functionSourceCode: dmFyIGp3dCA9IHJlcXVpcmUoJ2pzb253ZWJ0b2tlbicpOwp2YXIgYXhpb3MgPSByZXF1aXJlKCdheGlvcycpOwp2YXIgcmFuZG9tU3RyID0gcmVxdWlyZSgncmFuZG9tc3RyaW5nJyk7Cgp2YXIgSldLU19VUkkgICAgICAgICAgICAgICAgICAgID0gcHJvY2Vzcy5lbnYuQUFDSldLVVJMOwp2YXIgUkVTT1VSQ0VfSUQgICAgICAgICAgICAgICAgID0gcHJvY2Vzcy5lbnYuQUFDUkVTT1VSQ0VJRDsKdmFyIEdSQUZBTkFfRU5EUE9JTlQgICAgICAgICAgICA9IHByb2Nlc3MuZW52LkdSQUZBTkFFTkRQT0lOVDsKdmFyIEdSQUZBTkFfQVVUSCAgICAgICAgICAgICAgICA9IHByb2Nlc3MuZW52LkdSQUZBTkFBVVRIOwp2YXIgQ1VTVE9NQ0xBSU1fUk9MRVMgPSAnZ3JhZmFuYS9yb2xlcycKCi8qKgoqIENoZWNrIEpXVCB0b2tlbiBpcyBwcmVzZW50LCBpcyB2YWxpZCB3aXRoIHJlc3BlY3QgdG8gdGhlIHByZWNvbmZpZ3VyZWQgSldLUywgYW5kIGlzIG5vdCBleHBpcmVkLgoqIElmIHRoZSBjaGVjayBpcyBwYXNzZWQsIHRoZW4gcmV0dXJuIGV4dHJhY3RlZCBjbGFpbXMuCiovCnZhciBleHRyYWN0Q2xhaW1zID0gYXN5bmMoY29udGV4dCwgaGVhZGVycywgY2FsbGJhY2spID0+IHsKZm9yICh2YXIgaCBpbiBoZWFkZXJzKSB7CiAgICBpZiAoaC50b0xvd2VyQ2FzZSgpID09PSAnYXV0aG9yaXphdGlvbicgJiYgaGVhZGVyc1toXSkgewogICAgICAgIC8vIEV4cGVjdCBoZWFkZXIgaW4gdGhlIGZvcm0gQmVhcmVyIDxKV1Q+CiAgICAgICAgdmFyIHRva2VuID0gaGVhZGVyc1toXS5zdWJzdHJpbmcoaGVhZGVyc1toXS5pbmRleE9mKCcgJykrMSk7CiAgICAgICAgdmFyIGp3a3NDbGllbnQgPSByZXF1aXJlKCdqd2tzLXJzYScpOwogICAgICAgIHZhciBjbGllbnQgPSBqd2tzQ2xpZW50KHsKICAgICAgICAgICAgandrc1VyaTogSldLU19VUkkKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBnZXRLZXkoaGVhZGVyLCBrZXlDYWxsYmFjayl7CiAgICAgICAgICAgIGlmIChjb250ZXh0LmtleSkgewogICAgICAgICAgICAgICAga2V5Q2FsbGJhY2sobnVsbCwgY29udGV4dC5rZXkpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNsaWVudC5nZXRTaWduaW5nS2V5KGhlYWRlci5raWQsIGZ1bmN0aW9uKGVyciwga2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgc2lnbmluZ0tleSA9IGtleSA/IGtleS5wdWJsaWNLZXkgfHwga2V5LnJzYVB1YmxpY0tleSA6IG51bGw7CiAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdOZXcga2V5ICcgKyBzaWduaW5nS2V5KTsKICAgICAgICAgICAgICAgIGlmKHNpZ25pbmdLZXkgPT09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjayhuZXcgY29udGV4dC5SZXNwb25zZSh7bWVzc2FnZTogJ01pc3Npbmcgc2lnbmluZyBrZXknfSwge30sICdhcHBsaWNhdGlvbi9qc29uJywgNDAxKSk7CiAgICAgICAgICAgICAgICBjb250ZXh0LmtleSA9IHNpZ25pbmdLZXk7CiAgICAgICAgICAgICAgICBrZXlDYWxsYmFjayhudWxsLCBzaWduaW5nS2V5KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogIAogICAgICAgIHZhciBvcHRpb25zID0geyBhdWRpZW5jZTogUkVTT1VSQ0VfSUQgfTsKICAgICAgICAgand0LnZlcmlmeSh0b2tlbiwgZ2V0S2V5LCBvcHRpb25zLCBmdW5jdGlvbihlcnIsIGRlY29kZWQpIHsKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mb1dpdGgoJ1ZlcmlmeSBqd3Q6IGNsYWltczogJywgZGVjb2RlZCk7CiAgICAgICAgICAgIGlmICghZGVjb2RlZCkgewkKICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdJbmNvcnJlY3Qgc2lnbmF0dXJlOiAnICwgZXJyOiBlcnJ9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA0MDEpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFjayhkZWNvZGVkKTsKICAgICAgICB9KTsgCiAgICAgICAgcmV0dXJuOyAKICAgIH0KfQpjb250ZXh0LmNhbGxiYWNrKG5ldyBjb250ZXh0LlJlc3BvbnNlKHttZXNzYWdlOiAnTWlzc2luZyB0b2tlbid9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA0MDApKTsKfSAKCi8qKgogKiBDaGVjayBpZiB0aGUgb3JnYW5pemF0aW9uIGV4aXN0cyBpbiBvcmRlciB0byBwcm92aXNpb24gaXQgYW5kIGFzc2lnbiB0aGUgcHJvcGVyIHJpZ2h0cyB0byB0aGUgdXNlcgogKiBpZiBub3QsIGNyZWF0ZSB0aGUgb3JnYW5pemF0aW9uCiAqLwp2YXIgaGFuZGxlT3JnYW5pemF0aW9ucyA9IGFzeW5jIChjb250ZXh0LCBvcmcsIHJvbGUsIHVzZXJuYW1lLCB1c2VySWQpID0+IHsKICAgIHZhciBvcmdfY2FsbHMgICAgICAgID0gW107CiAgICB2YXIgb3JnSWQgICAgICAgICAgICA9ICIiOwogICAgCiAgICBvcmdfY2FsbHMucHVzaCggYXhpb3MuZ2V0KEdSQUZBTkFfRU5EUE9JTlQgKyAnL2FwaS9vcmdzL25hbWUvJyArIG9yZywge2hlYWRlcnM6IHsnQXV0aG9yaXphdGlvbic6IEdSQUZBTkFfQVVUSH19KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdPcmdhbml6YXRpb24gJyArIG9yZyArICcgYWxyZWFkeSBleGlzdHMgaW4gR3JhZmFuYS4nLCByZXMpOwogICAgICAgICAgICBvcmdJZCA9IHJlcy5kYXRhLmlkOyAgICAgICAgICAgIAogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJvcmdhbml6YXRpb24gSWQ6ICIgKyBvcmdJZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBhc3NpZ24gdGhlIHByb3BlciByb2xlIHRvIHRoZSB1c2VyIGluc2lkZSB0aGUgb3JnYW5pemF0aW9uCiAgICAgICAgICAgIGhhbmRsZVVzZXJSb2xlcyhjb250ZXh0LCBvcmdJZCwgdXNlcm5hbWUsIHVzZXJJZCwgcm9sZSk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIHJldHVybiBheGlvcy5wb3N0KEdSQUZBTkFfRU5EUE9JTlQgKyAnL2FwaS9vcmdzJywge25hbWU6IG9yZ30sIHtoZWFkZXJzOiB7J0F1dGhvcml6YXRpb24nOiBHUkFGQU5BX0FVVEh9fSkKICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdPcmdhbml6YXRpb24gZG9lcyBub3QgZXhpc3QgaW4gR3JhZmFuYS5DcmVhdGluZyBvcmdhbml6YXRpb246ICcgKyBvcmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JnSWQgPSByZXMuZGF0YS5vcmdJZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIm9yZ2FuaXphdGlvbiBJZDogIiArIG9yZ0lkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXNzaWduIHRoZSBwcm9wZXIgcm9sZSB0byB0aGUgdXNlciBpbnNpZGUgdGhlIG9yZ2FuaXphdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlVXNlclJvbGVzKGNvbnRleHQsIG9yZ0lkLCB1c2VybmFtZSwgdXNlcklkLCByb2xlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yZ19jYWxscy5wdXNoKCdPcmdhbml6YXRpb24gZG9lcyBub3QgZXhpc3QgaW4gR3JhZmFuYS5DcmVhdGluZyBvcmdhbml6YXRpb246ICcgKyBvcmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdPcmdhbml6YXRpb24gZG9lcyBub3QgZXhpc3QgaW4gR3JhZmFuYS5DcmVhdGluZyBvcmdhbml6YXRpb246ICcgKyBvcmc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnRXJyb3Igd2hpbGUgY3JlYXRpbmcgb3JnYW5pemF0aW9uOiAnICsgb3JnICsgIiAiICsgZXJyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdHUkFGQU5BIGNhbGwgZmFpbHVyZTogJyArICdFcnJvciB3aGlsZSBjcmVhdGluZyBvcmdhbml6YXRpb246ICcgKyBvcmcgKyAiICIsIGVycjogZXJyfSwge30sICdhcHBsaWNhdGlvbi9qc29uJywgNTAwKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB9KTsgCiAgICAgICAgfSkKICAgICk7CiAgICByZXR1cm4gb3JnX2NhbGxzOyAgICAKfTsKLyoqCiAqIENyZWF0ZSB0aGUgZ2xvYmFsIHVzZXIgCiAqLwp2YXIgcHJvdmlzaW9uRW50aXRpZXMgPSBhc3luYyAoY29udGV4dCwgbmFtZSwgdXNlcmVtYWlsLCByb2xlcykgPT4gewogICAgdmFyIHBhc3N3ID0gcmFuZG9tU3RyLmdlbmVyYXRlKDgpOwogICAgdmFyIG9ialRvQmVTZW50ID0ge25hbWUgOiBuYW1lLCBlbWFpbCA6IHVzZXJlbWFpbCwgcGFzc3dvcmQgOiBwYXNzd307CiAgICB2YXIgdXNlcklkID0gMDsKICAgIGNvbnRleHQubG9nZ2VyLmluZm9XaXRoKCJIYW5kbGluZyBVc2VyIGNyZWF0aW9uOiIgKyBuYW1lICsgIiB3aXRoIHVzZXJuYW1lOiAiICsgdXNlcmVtYWlsKTsKICAgIHVzZXJJZCA9IGF3YWl0IGF4aW9zLmdldChHUkFGQU5BX0VORFBPSU5UICsgJy9hcGkvdXNlcnMvbG9va3VwP2xvZ2luT3JFbWFpbD0nICsgdXNlcmVtYWlsLCB7aGVhZGVyczogeydBdXRob3JpemF0aW9uJzogR1JBRkFOQV9BVVRIfX0pCiAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKXsKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnR2xvYmFsIHVzZXIgJyArIG5hbWUgKyAnICcgKyB1c2VyZW1haWwgKyAnIGFscmVhZHkgZXhpc3RzIGluIEdyYWZhbmEuJywgcmVzKTsKICAgICAgICAgICAgdXNlcklkID0gcmVzLmRhdGEuaWQ7CiAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgdXNlciBmcm9tIG9sZCBvcmdzCiAgICAgICAgICAgIHJlbW92ZVVzZXJGcm9tT3JnKGNvbnRleHQsIHVzZXJJZCwgcm9sZXMpOwogICAgICAgICAgICAvLyBwcm92aXNpb25pbmcgb3JnYW5pemF0aW9ucwogICAgICAgICAgICBmb3IgKHZhciBvcmcgaW4gcm9sZXMpIHsKICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ0luc2lkZSBsb29wIG9mIG9yZ3MgOiAnICsgb3JnICsgIiAiICsgcm9sZXNbb3JnXSk7CiAgICAgICAgICAgICAgICByb2xlTmFtZSA9IHJvbGVzW29yZ107CiAgICAgICAgICAgICAgICBoYW5kbGVPcmdhbml6YXRpb25zKGNvbnRleHQsIG9yZywgcm9sZU5hbWUsIHVzZXJlbWFpbCwgdXNlcklkKTsKICAgICAgICAgICAgfSAgICAgICAgIAogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgICAgIGF4aW9zLnBvc3QoR1JBRkFOQV9FTkRQT0lOVCArICcvYXBpL2FkbWluL3VzZXJzJywgb2JqVG9CZVNlbnQsIHtoZWFkZXJzOiB7J0F1dGhvcml6YXRpb24nOiBHUkFGQU5BX0FVVEh9fSkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ1VzZXIgJyArIG5hbWUgKyAnIHN1Y2Nlc3NmdWxseSBjcmVhdGVkIGluIEdyYWZhbmEuJyk7CiAgICAgICAgICAgICAgICAgICAgdXNlcklkID0gcmVzLmRhdGEuaWQ7CiAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSB1c2VyIGZyb20gb2xkIG9yZ3MKICAgICAgICAgICAgICAgICAgICByZW1vdmVVc2VyRnJvbU9yZyhjb250ZXh0LCB1c2VySWQsIHJvbGVzKTsKICAgICAgICAgICAgICAgICAgICAvLyBwcm92aXNpb25pbmcgb3JnYW5pemF0aW9ucwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG9yZyBpbiByb2xlcykgewogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdJbnNpZGUgbG9vcCBvZiBvcmdzIDogJyArIG9yZyArICIgIiArIHJvbGVzW29yZ10pOwogICAgICAgICAgICAgICAgICAgICAgICByb2xlTmFtZSA9IHJvbGVzW29yZ107CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZU9yZ2FuaXphdGlvbnMoY29udGV4dCwgb3JnLCByb2xlTmFtZSwgdXNlcmVtYWlsLCB1c2VySWQpOwogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5kYXRhLmlkOwogICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ0Vycm9yIHdoaWxlIGNyZWF0aW5nIHVzZXI6ICcgKyBuYW1lICsgZXJyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjayhuZXcgY29udGV4dC5SZXNwb25zZSh7bWVzc2FnZTogJ0dSQUZBTkEgY2FsbCBmYWlsdXJlOiAnICsgJ0Vycm9yIHdoaWxlIGNyZWF0aW5nIHVzZXI6ICcgKyBuYW1lLCBlcnI6IGVycn0sIHt9LCAnYXBwbGljYXRpb24vanNvbicsIDUwMCkpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwp9OwovKioKICogR2V0IHRoZSBsaXN0IG9mIG9yZ2FuaXphdGlvbnMgaW4gR3JhZmFuYQogKi8KdmFyIGdldExpc3RPcmdzT2ZVc2VyID0gYXN5bmMgKGNvbnRleHQsIHVzZXJJZCkgPT4gewogICAgcmV0dXJuIGF4aW9zLmdldChHUkFGQU5BX0VORFBPSU5UICsgJy9hcGkvdXNlcnMvJyArIHVzZXJJZCArICcvb3JncycsIHtoZWFkZXJzOiB7J0F1dGhvcml6YXRpb24nOiBHUkFGQU5BX0FVVEh9fSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXMpewogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJMaXN0IG9mIHVzZXIncyBvcmdhbml6YXRpb25zOiAiKQogICAgICAgICAgICBjb25zb2xlLmxvZyhyZXMuZGF0YSkKICAgICAgICAgICAgcmV0dXJuIHJlcy5kYXRhCiAgICAgICAgfSkKfQoKLyoqCiAqIFJlbW92ZSB0aGUgdXNlciBmcm9tIHRoZSBub24tYmVsb25naW5nIG9yZ2FuaXphdGlvbnMgCiAqLwp2YXIgcmVtb3ZlVXNlckZyb21PcmcgPSBhc3luYyAoY29udGV4dCwgdXNlcklkLCByb2xlcykgPT4gewogICAgb3JncyA9IGF3YWl0IGdldExpc3RPcmdzT2ZVc2VyKGNvbnRleHQsIHVzZXJJZCk7CiAgICBjb25zb2xlLmxvZyhPYmplY3Qua2V5cyhyb2xlcykpCiAgICBleGNsdWRlZE9yZ3MgPSBvcmdzLmZpbHRlcih2YWx1ZSA9PiAhT2JqZWN0LmtleXMocm9sZXMpLmluY2x1ZGVzKHZhbHVlLm5hbWUpKQogICAgY29udGV4dC5sb2dnZXIuaW5mbygiTGlzdCBvZiBvcmdhbml6YXRpb25zIHRvIGRlbGV0ZSB0aGUgdXNlciBmcm9tOiAiKQogICAgY29uc29sZS5sb2coZXhjbHVkZWRPcmdzKQogICAgZm9yKHZhciBjdXJyT3JnIGluIGV4Y2x1ZGVkT3Jncyl7CiAgICAgICAgYXhpb3MuZGVsZXRlKEdSQUZBTkFfRU5EUE9JTlQgKyAnL2FwaS9vcmdzLycgKyBleGNsdWRlZE9yZ3NbY3Vyck9yZ11bIm9yZ0lkIl0gKyAnL3VzZXJzLycgKyB1c2VySWQsIHtoZWFkZXJzOiB7J0F1dGhvcml6YXRpb24nOiBHUkFGQU5BX0FVVEh9fSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXMpewogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdVc2VyICcgKyB1c2VySWQgKyAnIHJlbW92ZWQgc3VjY2Vzc2Z1bGx5IGZyb20gb3JnOiAnICsgY3Vyck9yZyk7CiAgICAgICAgICAgIHJldHVybiByZXMuZGF0YQogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKG5ldyBjb250ZXh0LlJlc3BvbnNlKHttZXNzYWdlOiAnR1JBRkFOQSBjYWxsIGZhaWx1cmU6ICcgKyAgJ0Vycm9yIHdoaWxlIHJlbW92aW5nIHVzZXIgZnJvbSBPcmcuJyArIGN1cnJPcmcubmFtZSAsIGVycjogZXJyfSwge30sICdhcHBsaWNhdGlvbi9qc29uJywgNTAwKSk7CiAgICAgICAgfSkKICAgIH0gICAKfQoKLyoqCiAqICBBc3NpZ24gdGhlIHVzZXIgdG8gdGhlIHByb3BlciByb2xlIChBZG1pbiwgRWRpdG9yLCBWaWV3ZXIpCiAqLwp2YXIgaGFuZGxlVXNlclJvbGVzID0gYXN5bmMgKGNvbnRleHQsIG9yZ0lkLCB1c2VybmFtZSwgdXNlcklkLCByb2xlTmFtZSkgPT4gewogICAgdmFyIG9ialRvQmVTZW50ID0ge2xvZ2luT3JFbWFpbCA6IHVzZXJuYW1lLCAicm9sZSIgOiByb2xlTmFtZX07CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvV2l0aCgiSGFuZGxpbmcgUm9sZXMgb2YgdXNlcjoiICsgdXNlcm5hbWUgKyAiIGluIG9yZ2FuaXphdGlvbklkLiAiICsgb3JnSWQgKyAiLiBvYmpUb0JlU2VudCAiICwgb2JqVG9CZVNlbnQpOwogICAgYXhpb3MucG9zdChHUkFGQU5BX0VORFBPSU5UICsgJy9hcGkvb3Jncy8nICsgb3JnSWQgKyAnL3VzZXJzJywgb2JqVG9CZVNlbnQsIHtoZWFkZXJzOiB7J0F1dGhvcml6YXRpb24nOiBHUkFGQU5BX0FVVEh9fSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnUm9sZSAnICsgcm9sZU5hbWUgKyAnIHN1Y2Nlc3NmdWxseSBhc3NpZ25lZCB0byB1c2VyOiAnICsgdXNlcm5hbWUpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnVXNlciBpcyBhbHJlYWR5IG1lbWJlciBvZiB0aGlzIG9yZ2FuaXphdGlvbi4gU2V0dGluZyB0aGUgbmV3IHJvbGUgdG8gdGhlIG9yZ2FuaXphdGlvbiAnICsgb3JnSWQpOwogICAgICAgICAgICAgICAgb2JqVG9CZVNlbnQgPSB7InJvbGUiIDogcm9sZU5hbWV9OwogICAgICAgICAgICAgICAgYXhpb3MucGF0Y2goR1JBRkFOQV9FTkRQT0lOVCArICcvYXBpL29yZ3MvJyArIG9yZ0lkICsgJy91c2Vycy8nICsgdXNlcklkLCBvYmpUb0JlU2VudCwge2hlYWRlcnM6IHsnQXV0aG9yaXphdGlvbic6IEdSQUZBTkFfQVVUSH19KQogICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ1JvbGUgJyArIHJvbGVOYW1lICsgJyBzdWNjZXNzZnVsbHkgYXNzaWduZWQgdG8gdXNlcjogJyArIHVzZXJuYW1lKTsKICAgICAgICAgICAgICAgICAgICB9KSAuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdHUkFGQU5BIGNhbGwgZmFpbHVyZTogJyArICAnRXJyb3Igd2hpbGUgYXNzaWduaW5nIHJvbGUgJyArIHJvbGVOYW1lICsgJyB0byB1c2VyOiAnICsgdXNlcm5hbWUsIGVycjogZXJyfSwge30sICdhcHBsaWNhdGlvbi9qc29uJywgNTAwKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfSk7Cn07CmV4cG9ydHMuaGFuZGxlciA9IGFzeW5jKGNvbnRleHQsIGV2ZW50KSA9PiB7CiAgICBleHRyYWN0Q2xhaW1zKGNvbnRleHQsIGV2ZW50LmhlYWRlcnMsIGZ1bmN0aW9uKGNsYWltcykgewogICAgICAgIHRyeXsKICAgICAgICAgICAgLy8gZXh0cmFjdCByb2xlcwogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvV2l0aCgnUm9sZXMgZnJvbSBBQUMgZm9yIEdyYWZhbmE6ICcsIGNsYWltc1tDVVNUT01DTEFJTV9ST0xFU10pOwogICAgICAgICAgICB2YXIgbmFtZSAgPSBjbGFpbXMudXNlcm5hbWU7CiAgICAgICAgICAgIHZhciB1c2VybmFtZSA9IGNsYWltcy5lbWFpbDsgIAogICAgICAgICAgICB2YXIgcm9sZXMgPSBjbGFpbXNbQ1VTVE9NQ0xBSU1fUk9MRVNdOyAgICAgICAKICAgICAgICAgICAgaWYocm9sZXMgIT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgZ2xvYmFsIHVzZXIsIHRoZSBvcmdhbml6YXRpb25zIGFuZCBhc3NpbmcgdGhlIHByb3BlciByb2xlcyB0byB0aGUgdXNlcgogICAgICAgICAgICAgICAgcHJvdmlzaW9uRW50aXRpZXMoY29udGV4dCwgbmFtZSwgdXNlcm5hbWUsIHJvbGVzKTsKICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2socm9sZXMpOwogICAgICAgICAgICB9IGVsc2V7CiAgICAgICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKG5ldyBjb250ZXh0LlJlc3BvbnNlKHttZXNzYWdlOiAnTWlzc2luZyByb2xlcyBmcm9tIEFBQy4gQ2hlY2sgdGhlIGNsYWltIG1hcHBpbmcnfSwge30sICdhcHBsaWNhdGlvbi9qc29uJywgNTAwKSk7CiAgICAgICAgICAgIH0gCiAgICAgICAgfSBjYXRjaChlcnIpewogICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKG5ldyBjb250ZXh0LlJlc3BvbnNlKHttZXNzYWdlOiAnR1JBRkFOQSBjYWxsIGZhaWx1cmUnLCBlcnI6IGVycn0sIHt9LCAnYXBwbGljYXRpb24vanNvbicsIDUwMCkpOwogICAgICAgIH0gICAgICAKICAgIH0pOwp9Owo=
    registry: {{ .Values.registry.pushPullUrl }}
    runtimeAttributes:
      repositories: []
    timestamp: 1595407196
  description: Provision Users,Organizations, Roles for Grafana
  env:
  - name: AACJWKURL
    value: {{ .Values.sysfunction.grafana.aacjwkurl }}
  - name: AACRESOURCEID
    value: {{ .Values.sysfunction.grafana.aacresourceid }}
  - name: GRAFANAAUTH
    value: {{ .Values.sysfunction.grafana.grafanaauth }}
  - name: GRAFANAENDPOINT
    value: {{ .Values.sysfunction.grafana.grafanaendpoint }}
  eventTimeout: ""
  handler: main:handler
  image: {{ .Values.registry.pushPullUrl }}/nuclio-sys-nodejs-grafana-connector:latest
  imageHash: "1595407145593988592"
  imagePullSecrets: registry-credentials
  loggerSinks:
  - level: debug
  maxReplicas: 1
  minReplicas: 1
  platform: {}
  readinessTimeoutSeconds: 60
  resources: {}
  runRegistry: {{ .Values.registry.pushPullUrl }}
  runtime: nodejs
  serviceType: NodePort
  targetCPU: 75
  version: -1
status:
  httpPort: 30041
  scaleToZero:
    lastScaleEvent: resourceUpdated
    lastScaleEventTime: "2020-07-22T08:40:26.788055454Z"
  state: ready
{{- end }}
