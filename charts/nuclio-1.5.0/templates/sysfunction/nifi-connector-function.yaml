{{- if .Values.sysfunction.nifi.enabled }}
apiVersion: nuclio.io/v1beta1
kind: NuclioFunction
metadata:
  labels:
    nuclio.io/project-name: nifi
  name: nodejs-nifi-connector
  namespace: sys
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
spec:
  alias: latest
  build:
    codeEntryType: sourceCode
    commands:
    - npm install --global moment
    - npm install --global jsonwebtoken
    - npm install --global axios
    - npm install --global jwks-rsa
    - npm install --global request
    functionSourceCode: CnZhciBqd3QgPSByZXF1aXJlKCdqc29ud2VidG9rZW4nKTsKdmFyIGF4aW9zID0gcmVxdWlyZSgnYXhpb3MnKTsKdmFyIGZzID0gcmVxdWlyZSgnZnMnKTsKdmFyIGh0dHBzID0gcmVxdWlyZSgnaHR0cHMnKTsKCnZhciBKV0tTX1VSSSAgICAgICAgICAgICAgICAgPSBwcm9jZXNzLmVudi5BQUNKV0tVUkw7CnZhciBDTElFTlRfSUQgICAgICAgICAgICAgICAgPSBwcm9jZXNzLmVudi5BQUNDTElFTlRJRDsKdmFyIE5JRklfRU5EUE9JTlQgICAgICAgICAgICA9IHByb2Nlc3MuZW52Lk5JRklFTkRQT0lOVDsKdmFyIENVU1RPTUNMQUlNX1JPTEVTICAgICAgICA9ICJuaWZpL3JvbGVzIjsKdmFyIE5JRklfUEFSRU5UX1JPT1QgICAgICAgICA9ICJyb290IjsKdmFyIE5JRklfUk9MRV9NQU5BR0VSICAgICAgICA9ICdST0xFX01BTkFHRVInOwp2YXIgTklGSV9ST0xFUyAgICAgICAgICAgICAgID0gWydST0xFX01PTklUT1InLCBOSUZJX1JPTEVfTUFOQUdFUl07CnZhciBUWVBFX1BST0NFU1NfR1JPVVAgICAgICAgPSAiL3Byb2Nlc3MtZ3JvdXBzLyI7IC8vIHZpZXcvbW9kaWZ5IHByb2Nlc3MgZ3JvdXAgZmxvdwp2YXIgVFlQRV9PUEVSQVRJT04gICAgICAgICAgID0gIi9vcGVyYXRpb24vcHJvY2Vzcy1ncm91cHMvIjsgLy8gb3BlcmF0ZSAocnVuLCBzdG9wLCBldGMuKSB0aGUgcHJvY2VzcyBncm91cAp2YXIgVFlQRV9QUk9WRU5BTkNFICAgICAgICAgID0gIi9wcm92ZW5hbmNlLWRhdGEvcHJvY2Vzcy1ncm91cHMvIjsgLy8gdmlldyBwcm92ZW5hbmNlIGV2ZW50cwp2YXIgVFlQRV9EQVRBICAgICAgICAgICAgICAgID0gIi9kYXRhL3Byb2Nlc3MtZ3JvdXBzLyI7IC8vIHZpZXcvZW1wdHkgcXVldWVzLCB2aWV3IG1ldGFkYXRhLCBzdWJtaXQgcmVwbGF5cwp2YXIgQUNUSU9OX1JFQUQgICAgICAgICAgICAgID0gInJlYWQiOwp2YXIgQUNUSU9OX1dSSVRFICAgICAgICAgICAgID0gIndyaXRlIjsKdmFyIEFETUlOX1VTRVIgICAgICAgICAgICAgICA9ICJhZG1pbiI7Cgpjb25zdCBodHRwc0FnZW50ID0gbmV3IGh0dHBzLkFnZW50KHsKICBjZXJ0OiBmcy5yZWFkRmlsZVN5bmMoJy4vY2VydGlmaWNhdGVzL2FkbWluLWNlcnQucGVtJyksCiAga2V5OiBmcy5yZWFkRmlsZVN5bmMoJy4vY2VydGlmaWNhdGVzL2FkbWluLXByaXZhdGUta2V5LnBlbScpLAogIGNhOiBmcy5yZWFkRmlsZVN5bmMoJy4vY2VydGlmaWNhdGVzL25pZmktY2VydC5wZW0nKQp9KQoKLyoqCiogQ2hlY2sgSldUIHRva2VuIGlzIHByZXNlbnQsIGlzIHZhbGlkIHdpdGggcmVzcGVjdCB0byB0aGUgcHJlY29uZmlndXJlZCBKV0tTLCBhbmQgaXMgbm90IGV4cGlyZWQuCiogSWYgdGhlIGNoZWNrIGlzIHBhc3NlZCwgdGhlbiByZXR1cm4gZXh0cmFjdGVkIGNsYWltcy4KKi8KdmFyIGV4dHJhY3RDbGFpbXMgPSBhc3luYyhjb250ZXh0LCBoZWFkZXJzLCBjYWxsYmFjaykgPT4gewpmb3IgKHZhciBoIGluIGhlYWRlcnMpIHsKICAgIGlmIChoLnRvTG93ZXJDYXNlKCkgPT09ICdhdXRob3JpemF0aW9uJyAmJiBoZWFkZXJzW2hdKSB7CiAgICAgICAgLy8gRXhwZWN0IGhlYWRlciBpbiB0aGUgZm9ybSBCZWFyZXIgPEpXVD4KICAgICAgICB2YXIgdG9rZW4gPSBoZWFkZXJzW2hdLnN1YnN0cmluZyhoZWFkZXJzW2hdLmluZGV4T2YoJyAnKSsxKTsKICAgICAgICB2YXIgandrc0NsaWVudCA9IHJlcXVpcmUoJ2p3a3MtcnNhJyk7CiAgICAgICAgdmFyIGNsaWVudCA9IGp3a3NDbGllbnQoewogICAgICAgICAgICBqd2tzVXJpOiBKV0tTX1VSSQogICAgICAgIH0pOwogICAgICAgIGZ1bmN0aW9uIGdldEtleShoZWFkZXIsIGtleUNhbGxiYWNrKXsKICAgICAgICAgICAgaWYgKGNvbnRleHQua2V5KSB7CiAgICAgICAgICAgICAgICBrZXlDYWxsYmFjayhudWxsLCBjb250ZXh0LmtleSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xpZW50LmdldFNpZ25pbmdLZXkoaGVhZGVyLmtpZCwgZnVuY3Rpb24oZXJyLCBrZXkpIHsKICAgICAgICAgICAgICAgIHZhciBzaWduaW5nS2V5ID0ga2V5ID8ga2V5LnB1YmxpY0tleSB8fCBrZXkucnNhUHVibGljS2V5IDogbnVsbDsKICAgICAgICAgICAgICAgIC8vY29udGV4dC5sb2dnZXIuaW5mbygnTmV3IGtleSAnICsgc2lnbmluZ0tleSk7CiAgICAgICAgICAgICAgICBpZihzaWduaW5nS2V5ID09PSBudWxsKQogICAgICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdNaXNzaW5nIHNpZ25pbmcga2V5J30sIHt9LCAnYXBwbGljYXRpb24vanNvbicsIDQwMSkpOwogICAgICAgICAgICAgICAgY29udGV4dC5rZXkgPSBzaWduaW5nS2V5OwogICAgICAgICAgICAgICAga2V5Q2FsbGJhY2sobnVsbCwgc2lnbmluZ0tleSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgCiAgICAgICAgdmFyIG9wdGlvbnMgPSB7IGF1ZGllbmNlOiBDTElFTlRfSUQgfTsKICAgCiAgICAgICAgand0LnZlcmlmeSh0b2tlbiwgZ2V0S2V5LCBvcHRpb25zLCBmdW5jdGlvbihlcnIsIGRlY29kZWQpIHsKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mb1dpdGgoJ1ZlcmlmeSBqd3Q6IGNsYWltczogJywgZGVjb2RlZCk7CiAgICAgICAgICAgIGlmICghZGVjb2RlZCkgewkKICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdJbmNvcnJlY3Qgc2lnbmF0dXJlOiAnICwgZXJyOiBlcnJ9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA0MDEpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFjayhkZWNvZGVkKTsKICAgICAgICB9KTsgCiAgICAgICAgcmV0dXJuOyAKICAgIH0KfQpjb250ZXh0LmNhbGxiYWNrKG5ldyBjb250ZXh0LlJlc3BvbnNlKHttZXNzYWdlOiAnTWlzc2luZyB0b2tlbid9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA0MDApKTsKfSAKLyoqCiAqIENyZWF0ZSBQcm9jZXNzR3JvdXAKICovCnZhciBjcmVhdGVQcm9jZXNzR3JvdXAgPSBhc3luYyAocGFyZW50SWQsIHByb2Nlc3NHcm91cE5hbWUsIHByb2Nlc3NHcm91cElkLCBhc3NpZ25Sb2xlLCByb2xlTmFtZSwgdXNlcm5hbWUpID0+ewogICAgaWYocHJvY2Vzc0dyb3VwSWQgPT09IDApewogICAgICAgIHZhciBuZXdQR0lkID0gYXdhaXQgY3JlYXRlUEcocGFyZW50SWQsIHByb2Nlc3NHcm91cE5hbWUpOwogICAgICAgIGF3YWl0IGNyZWF0ZVVzZXIodXNlcm5hbWUpOwogICAgICAgIGF3YWl0IE5JRklfUk9MRVMucmVkdWNlKChwLHJvbGUpID0+IHAudGhlbigoKSA9PiBoYW5kbGVVc2VyR3JvdXAocHJvY2Vzc0dyb3VwTmFtZSArICI6IiArIHJvbGUpKSwgUHJvbWlzZS5yZXNvbHZlKG51bGwpKTsKICAgICAgICBhd2FpdCBhc3NpZ25Qb2xpY3kobmV3UEdJZCwgcHJvY2Vzc0dyb3VwTmFtZSwgdXNlcm5hbWUpOwogICAgICAgIGlmKGFzc2lnblJvbGUpIGFzc2lnblJvbGUyVXNlcihwcm9jZXNzR3JvdXBOYW1lICsgIjoiICsgcm9sZU5hbWUsIHVzZXJuYW1lLCBuZXdQR0lkKTsKICAgICAgICByZXR1cm4gW25ld1BHSWQsIDAsIDBdCiAgICB9IGVsc2V7CiAgICAgICAgYXdhaXQgY3JlYXRlVXNlcih1c2VybmFtZSk7CiAgICAgICAgYXdhaXQgTklGSV9ST0xFUy5yZWR1Y2UoKHAscm9sZSkgPT4gcC50aGVuKCgpID0+IGhhbmRsZVVzZXJHcm91cChwcm9jZXNzR3JvdXBOYW1lICsgIjoiICsgcm9sZSkpLCBQcm9taXNlLnJlc29sdmUobnVsbCkpOwogICAgICAgIGF3YWl0IGFzc2lnblBvbGljeShwcm9jZXNzR3JvdXBJZCwgcHJvY2Vzc0dyb3VwTmFtZSwgdXNlcm5hbWUpOwogICAgICAgIGlmKGFzc2lnblJvbGUpIGFzc2lnblJvbGUyVXNlcihwcm9jZXNzR3JvdXBOYW1lICsgIjoiICsgcm9sZU5hbWUsIHVzZXJuYW1lLCBwcm9jZXNzR3JvdXBJZCk7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbcHJvY2Vzc0dyb3VwSWQsIHByb2Nlc3NHcm91cE5hbWUsIHBhcmVudElkXSk7CiAgICB9Cn0KCnZhciBjcmVhdGVQRyA9IChwYXJlbnRJZCwgcHJvY2Vzc0dyb3VwTmFtZSkgPT57CiAgICB2YXIgb2JqVG9CZVNlbnQgPSB7J3JldmlzaW9uJzogeyd2ZXJzaW9uJzogMH0sICdjb21wb25lbnQnOiB7J25hbWUnOiBwcm9jZXNzR3JvdXBOYW1lLCAncG9zaXRpb24nOiB7J3gnOk1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSoxMDAwKSwgJ3knOk1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSoxMDAwKX19fTsKICAgIGNvbnNvbGUubG9nKCJJbnNpZGUgUEcgY3JlYXRpb24gb2YgcHJvY2Vzc0dyb3VwTmFtZTogIiArIHByb2Nlc3NHcm91cE5hbWUgKyAiICIgKyBOSUZJX0VORFBPSU5UICsgJy9wcm9jZXNzLWdyb3Vwcy8nICsgcGFyZW50SWQgKyAnL3Byb2Nlc3MtZ3JvdXBzJyk7CiAgICByZXR1cm4gYXhpb3MucG9zdChOSUZJX0VORFBPSU5UICsgJy9wcm9jZXNzLWdyb3Vwcy8nICsgcGFyZW50SWQgKyAnL3Byb2Nlc3MtZ3JvdXBzJywgb2JqVG9CZVNlbnQsIHtodHRwc0FnZW50fSkKICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJjcmVhdGVkIHBnaWQgIiArIHJlc3BvbnNlLmRhdGEuaWQpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5pZDsKICAgICAgICB9KQogICAgICAgIC5jYXRjaChlcnJvciA9PiB7Y29uc29sZS5sb2coIlByb2JsZW0gZHVyaW5nIFBHIGNyZWF0aW9uICIgKyBlcnJvcik7fSk7Cn0KCi8qKgogKiBMaXN0IFByb2Nlc3NHcm91cHMKICovCnZhciBnZXRQR0lkID0gKHBhcmVudElkLCBwcm9jZXNzR3JvdXBOYW1lKSA9PiB7CiAgICBjb25zb2xlLmxvZygiSW5zaWRlIGdldFBHSWQ6ICIgKyBwcm9jZXNzR3JvdXBOYW1lICsgIiAiICsgTklGSV9FTkRQT0lOVCArICcvZmxvdy9wcm9jZXNzLWdyb3Vwcy8nICsgcGFyZW50SWQgKyAnL3N0YXR1cz9yZWN1cnNpdmU9ZmFsc2UnKTsKICAgIHJldHVybiBheGlvcy5nZXQoTklGSV9FTkRQT0lOVCArICcvZmxvdy9wcm9jZXNzLWdyb3Vwcy8nICsgcGFyZW50SWQgKyAnL3N0YXR1cz9yZWN1cnNpdmU9ZmFsc2UnLCAge2h0dHBzQWdlbnR9KQogICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICAgICAgdmFyIHBnSWQgPSByZWFkUmVjdXJzaXZlUEcocmVzcG9uc2UuZGF0YS5wcm9jZXNzR3JvdXBTdGF0dXMuYWdncmVnYXRlU25hcHNob3QsIHByb2Nlc3NHcm91cE5hbWUpOwogICAgICAgICAgICByZXR1cm4gW3BhcmVudElkLCBwZ0lkXTsKICAgICAgICAgfSkKICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQcm9ibGVtIGluIGdldCByZXNwb25zZSBvZiByZWN1cnNpdmUgcHJvY2VzcyBncm91cHMuIGdldFBHSWQnICsgZXJyKTsKICAgICAgICB9KTsKfQoKLyoqCiAqIEZpbmQgdGhlIHByb3BlciBwcm9jZXNzIGdyb3VwIElkIGJ5IGNoZWNraW5nIGluIHRoZSBkZXNjZW5kYW50IGdyb3VwcyBvZiB0aGUgY3VycmVudCBub2RlCiAqLwp2YXIgcmVhZFJlY3Vyc2l2ZVBHID0gIChwZ1NuYXBzaG90cywgcHJvY2Vzc0dyb3VwTmFtZSkgPT4gewogICAgY29uc29sZS5sb2coIkluc2lkZSByZWFkUmVjdXJzaXZlUEc6ICIgKyBwcm9jZXNzR3JvdXBOYW1lKTsKICAgIHZhciBjdXJyU25hcFNob3RzOwogICAgaWYocGdTbmFwc2hvdHMgIT09IG51bGwgJiYgcGdTbmFwc2hvdHMucHJvY2Vzc0dyb3VwU3RhdHVzU25hcHNob3RzICE9PSBudWxsICYmIAogICAgICAgIHBnU25hcHNob3RzICE9IHVuZGVmaW5lZCAmJiBwZ1NuYXBzaG90cy5wcm9jZXNzR3JvdXBTdGF0dXNTbmFwc2hvdHMgIT0gdW5kZWZpbmVkICYmCiAgICAgICAgcGdTbmFwc2hvdHMucHJvY2Vzc0dyb3VwU3RhdHVzU25hcHNob3RzLmxlbmd0aCA+IDApewogICAgICAgIGZvcih2YXIgaT0wOyBpPHBnU25hcHNob3RzLnByb2Nlc3NHcm91cFN0YXR1c1NuYXBzaG90cy5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGN1cnJTbmFwU2hvdHMgPSBwZ1NuYXBzaG90cy5wcm9jZXNzR3JvdXBTdGF0dXNTbmFwc2hvdHNbaV07CiAgICAgICAgICAgIGlmKGN1cnJTbmFwU2hvdHMgIT09IG51bGwpewogICAgICAgICAgICAgICAgdmFyIGN1cnJTbmFwID0gY3VyclNuYXBTaG90cy5wcm9jZXNzR3JvdXBTdGF0dXNTbmFwc2hvdDsKICAgICAgICAgICAgICAgIGlmKGN1cnJTbmFwICE9PSBudWxsKXsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiSW5zaWRlIHJlYWRSZWN1cnNpdmVQRyBmb3IgcGdJZCAiICsgY3VyclNuYXAuaWQgKyAiIGFuZCBwZ05hbWU6ICIgKyBjdXJyU25hcC5uYW1lKTsKICAgICAgICAgICAgICAgICAgICBpZihjdXJyU25hcC5uYW1lID09PSBwcm9jZXNzR3JvdXBOYW1lKXsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlByb2Nlc3NHcm91cCBuYW1lIGZvdW5kOiAiICsgY3VyclNuYXAubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjdXJyU25hcC5pZDsKICAgICAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgICAgIC8vdmFyIHJldCA9IHJlYWRSZWN1cnNpdmVQRyhjdXJyU25hcCwgcHJvY2Vzc0dyb3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgLy9pZihyZXQgIT0gMCApewogICAgICAgICAgICAgICAgICAgIC8vICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgICAgICAgICAgLy99CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gMDsKfQoKLyoqCiAqIENyZWF0ZSBVc2VyR3JvdXAKICovCnZhciBoYW5kbGVVc2VyR3JvdXAgPSAodXNlckdycE5hbWUpID0+IHsKICAgIHZhciBvYmpUb0JlU2VudCA9IHsncmV2aXNpb24nOiB7J3ZlcnNpb24nOiAwfSwnY29tcG9uZW50JzogeydpZGVudGl0eSc6IHVzZXJHcnBOYW1lfX07CiAgICByZXR1cm4gYXhpb3MucG9zdChOSUZJX0VORFBPSU5UICsgJy90ZW5hbnRzL3VzZXItZ3JvdXBzJywgb2JqVG9CZVNlbnQsIHtodHRwc0FnZW50fSkKICAgICAgICAudGhlbihyZXMgPT4ge2NvbnNvbGUubG9nKCdVc2VyIEdyb3VwICcgKyB1c2VyR3JwTmFtZSArICcgc3VjY2Vzc2Z1bGx5IGNyZWF0ZWQuICcpO3JldHVybiByZXMuZGF0YS5pZDt9KQogICAgICAgIC5jYXRjaChlcnIgPT4gY29uc29sZS5sb2coJ0R1cmluZyB1c2VyIEdyb3VwIGNyZWF0aW9uLiBVc2VyR3JvdXAgJyArIHVzZXJHcnBOYW1lICsgJyBhbHJlYWR5IGV4aXN0cy4gJyArIGVycikpOwp9CgovKioKICogZ2V0IFVzZXJHcm91cAogKi8KdmFyIGdldFVzZXJHcm91cCA9ICh1c2VyR3JwTmFtZSkgPT4gewogICAgcmV0dXJuIGF4aW9zLmdldChOSUZJX0VORFBPSU5UICsgJy90ZW5hbnRzL3VzZXItZ3JvdXBzJywge2h0dHBzQWdlbnR9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICB2YXIgdXNlckdycGxpc3QgPSByZXMuZGF0YS51c2VyR3JvdXBzOwogICAgICAgICAgICBmb3IodmFyIGk9MDsgaTx1c2VyR3JwbGlzdC5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgICBpZih1c2VyR3JwbGlzdFtpXS5jb21wb25lbnQuaWRlbnRpdHkgPT0gdXNlckdycE5hbWUpewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1c2VyR3JwbGlzdFtpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3IgZHVyaW5nIGdldFVzZXJHcm91cCAnICsgZXJyKTsKICAgICAgICB9KTsKfQovKioKICogQ3JlYXRlIFVzZXIKICovCnZhciBjcmVhdGVVc2VyID0gYXN5bmModXNlck5hbWUpID0+IHsKICAgIHZhciBvYmpUb0JlU2VudCA9IHsncmV2aXNpb24nOiB7J3ZlcnNpb24nOiAwfSwnY29tcG9uZW50JzogeydpZGVudGl0eSc6IHVzZXJOYW1lfX07CiAgICBjb25zb2xlLmxvZygiSW5zaWRlIGNyZWF0ZVVzZXIuLi4iKTsKICAgIGF3YWl0IGdldFBvbGljeShBQ1RJT05fUkVBRCwgIi9mbG93IikudGhlbihwb2xpY3lVSSA9PnsKICAgICAgICBheGlvcy5wb3N0KE5JRklfRU5EUE9JTlQgKyAnL3RlbmFudHMvdXNlcnMnLCBvYmpUb0JlU2VudCwge2h0dHBzQWdlbnR9KQogICAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdVc2VyICcgKyB1c2VyTmFtZSArICcgc3VjY2Vzc2Z1bGx5IGNyZWF0ZWQuICcpOwogICAgICAgICAgICAgICAgaWYocG9saWN5VUkgIT0gbnVsbCl7CiAgICAgICAgICAgICAgICAgICAgcG9saWN5VUkuY29tcG9uZW50LnVzZXJzLnB1c2goeydyZXZpc2lvbic6IHsndmVyc2lvbic6IDB9LCAnaWQnOiByZXMuZGF0YS5pZCwnY29tcG9uZW50JzogeydpZGVudGl0eSc6IHVzZXJOYW1lLCdpZCc6IHJlcy5kYXRhLmlkfX0pOwogICAgICAgICAgICAgICAgICAgIGF4aW9zLnB1dChOSUZJX0VORFBPSU5UICsgJy9wb2xpY2llcy8nKyBwb2xpY3lVSVsnaWQnXSwgcG9saWN5VUksIHtodHRwc0FnZW50fSkKICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4ocmVzdWx0ID0+IGNvbnNvbGUubG9nKCdVc2VyIGFzc2lnbmVkIHN1Y2Nlc3NmdWxseSB0byB0aGUgcG9saWN5IHRvIHZpZXcgdGhlIFVJICcpKQogICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4gY29uc29sZS5sb2coJ0Vycm9yIGR1cmluZyB1c2VyIGFzc2lnbm1lbnQgdG8gdGhlIHBvbGljeSB0byB2aWV3VUkuICcgKyBlcnJvcikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5kYXRhLmlkOwogICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRHVyaW5nIHVzZXIgY3JlYXRpb24uIFVzZXIgJyArIHVzZXJOYW1lICsgJyBhbHJlYWR5IGV4aXN0cyAnICsgZXJyKTsKICAgICAgICAgICAgfSk7CiAgICB9KQp9CgovKioKICogZ2V0IFVzZXIKICovCnZhciBnZXRVc2VyID0gKHVzZXJOYW1lKSA9PiB7CiAgICBjb25zb2xlLmxvZygiSW5zaWRlIGdldFVzZXIgIiArIHVzZXJOYW1lKTsKICAgIHJldHVybiBheGlvcy5nZXQoTklGSV9FTkRQT0lOVCArICcvdGVuYW50cy91c2VycycsIHtodHRwc0FnZW50fSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgdmFyIHVzZXJsaXN0ID0gcmVzLmRhdGEudXNlcnM7CiAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpPHVzZXJsaXN0Lmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgIGlmKHVzZXJsaXN0W2ldLmNvbXBvbmVudC5pZGVudGl0eSA9PT0gdXNlck5hbWUpewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1c2VybGlzdFtpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge2NvbnNvbGUubG9nKGVycm9yKTsgcmV0dXJuIHt9O30pOwogICAgfQoKLyoqCiAqIERlbGV0ZSBVc2VyCiAqLwp2YXIgZGVsZXRlVXNlciA9IGFzeW5jICh1c2VySWQpID0+IHsKICAgIGNvbnNvbGUubG9nKCJJbnNpZGUgZGVsZXRlVXNlciAiICsgdXNlcklkKTsKICAgIHJldHVybiBheGlvcy5kZWxldGUoTklGSV9FTkRQT0lOVCArICcvdGVuYW50cy91c2Vycy8nKyB1c2VySWQgKyAnP3ZlcnNpb249MCcsIHtodHRwc0FnZW50fSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coIlVzZXIgIiArIHVzZXJJZCArICIgc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQiKQogICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge2NvbnNvbGUubG9nKGVycm9yKTsgcmV0dXJuIHt9O30pOwogICAgfQoKLyoqCiAqIFVwZGF0ZSBVc2VyCiAqLwp2YXIgdXBkYXRlVXNlciA9IGFzeW5jICh1c2VySWQsIHVzZXJOYW1lKSA9PiB7CiAgICBjb25zb2xlLmxvZygiSW5zaWRlIHVwZGF0ZVVzZXIgIiArIHVzZXJJZCk7CiAgICBvYmpUb0JlU2VudCA9IHsncmV2aXNpb24nOiB7J3ZlcnNpb24nOiAwfSwgJ2lkJzogdXNlcklkLCdjb21wb25lbnQnOiB7J2lkZW50aXR5JzogdXNlck5hbWUsJ2lkJzogdXNlcklkLCB1c2VyR3JvdXBzOiBbXX0gfTsKICAgIHJldHVybiBheGlvcy5wdXQoTklGSV9FTkRQT0lOVCArICcvdGVuYW50cy91c2Vycy8nKyB1c2VySWQsIHtodHRwc0FnZW50fSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coIlVzZXIgIiArIHVzZXJJZCArICIgc3VjY2Vzc2Z1bGx5IGRlbGV0ZWQiKQogICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge2NvbnNvbGUubG9nKGVycm9yKTsgcmV0dXJuIHt9O30pOwogICAgfQoKCi8qKgogKiBhc3NpZ24gcm9sZSB0byB1c2VyCiAqLwp2YXIgYXNzaWduUm9sZTJVc2VyID0gYXN5bmMgKHJvbGUsIHVzZXJOYW1lLCBwcm9jZXNzR3JwSWQpID0+IHsKICAgIGNvbnNvbGUubG9nKCJJbnNpZGUgYXNzaWduUm9sZTJVc2VyLi4uIik7CiAgICB2YXIgdXNlciA9IGF3YWl0IGdldFVzZXIodXNlck5hbWUpOwogICAgaWYodXNlciAhPT0gbnVsbCAmJiB1c2VyICE9PSB1bmRlZmluZWQgJiYgdXNlciAhPSB7fSl7CiAgICAgICAgdmFyIHVzZXJHcnAgPSBhd2FpdCBnZXRVc2VyR3JvdXAocm9sZSk7CiAgICAgICAgdXNlckdycC5jb21wb25lbnQudXNlcnMucHVzaCh7J3JldmlzaW9uJzogdXNlci5yZXZpc2lvbiwgImlkIjogdXNlci5pZH0pOwogICAgICAgIHZhciBncm91cElkID0gdXNlckdycC5pZDsKICAgICAgICBjb25zb2xlLmxvZyhOSUZJX0VORFBPSU5UICsgJy90ZW5hbnRzL3VzZXItZ3JvdXBzLycgKyBncm91cElkKTsKICAgICAgICAvL2Fzc2lnbiB1c2VyIHRvIHVzckdycAogICAgICAgIGF3YWl0IGF4aW9zLnB1dChOSUZJX0VORFBPSU5UICsgJy90ZW5hbnRzL3VzZXItZ3JvdXBzLycgKyBncm91cElkLCB1c2VyR3JwLCB7aHR0cHNBZ2VudH0pCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1VzZXIgc3VjY2Vzc2Z1bGx5IGFzc2lnbmVkIHRvIHRoZSB1c2VyR3JwJyk7CiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFcnJvciBkdXJpbmcgIGFzc2lnblJvbGUyVXNlcjogYXNzaWduIHVzZXIgdG8gdXNyR3JwICcgKyBlcnIpOwogICAgICAgICAgICB9KTsKICAgICAgICAvLyBhc3NpZ24gdXNlciB0byBwb2xpY3kKICAgICAgICB2YXIgcG9saWN5TmFtZSA9IFRZUEVfUFJPQ0VTU19HUk9VUCArIHByb2Nlc3NHcnBJZDsKICAgICAgICB2YXIgcG9saWN5ID0gYXdhaXQgZ2V0UG9saWN5KEFDVElPTl9SRUFELCBwb2xpY3lOYW1lKTsKICAgICAgICBwb2xpY3kuY29tcG9uZW50LnVzZXJzLnB1c2goeydyZXZpc2lvbic6IHVzZXIucmV2aXNpb24sICJpZCI6IHVzZXIuaWR9KTsKICAgICAgICBjb25zb2xlLmxvZyhOSUZJX0VORFBPSU5UICsgJy9wb2xpY2llcy8nICsgcG9saWN5LmlkKTsKICAgICAgICBhd2FpdCBheGlvcy5wdXQoTklGSV9FTkRQT0lOVCArICcvcG9saWNpZXMvJyArIHBvbGljeS5pZCwgcG9saWN5LCB7aHR0cHNBZ2VudH0pCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1VzZXIgc3VjY2Vzc2Z1bGx5IGFzc2lnbmVkIHRvIHRoZSBwb2xpY3kgJytwb2xpY3lOYW1lKTsKICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yIGR1cmluZyAgYXNzaWduUm9sZTJVc2VyOiBhc3NpZ24gdXNlciB0byBwb2xpY3kgJyArIHBvbGljeU5hbWUgKyAiICIrIGVycik7CiAgICAgICAgICAgIH0pOwogICAgfSBlbHNlewogICAgICAgIGNvbnNvbGUubG9nKCJVc2VyIG5vdCBmb3VuZCBpbiBhc3NpZ25Sb2xlMlVzZXIiKTsKICAgIH0KfQoKLyoqCiAqIENyZWF0ZSBQb2xpY3kKICovCnZhciBjcmVhdGVQb2xpY3kgPSBhc3luYyAoYWN0aW9uLCByZXNvdXJjZSwgUEdOYW1lLCB1c2VyR3JwcywgdXNlck5hbWUpID0+IHsKICAgIGNvbnNvbGUubG9nKCJJbnNpZGUgY3JlYXRlUG9saWN5Iik7IAogICAgdmFyIG5ld1VzZXJHcnBzID0gcHJlcGFyZVVHNFBvbGljeShQR05hbWUsIHVzZXJHcnBzLCBhY3Rpb24pOwogICAgYXdhaXQgZ2V0VXNlcihBRE1JTl9VU0VSKS50aGVuKGFkbWluVXNlciA9PnsKICAgICAgICB2YXIgdXNyID0geydyZXZpc2lvbic6IHsndmVyc2lvbic6IDB9LCdpZCc6IGFkbWluVXNlci5pZH07CiAgICAgICAgdmFyIG9ialRvQmVTZW50ID0geydyZXZpc2lvbic6IHsndmVyc2lvbic6IDB9LCdjb21wb25lbnQnOiB7J2FjdGlvbic6IGFjdGlvbiwgJ3Jlc291cmNlJzpyZXNvdXJjZSwgJ3VzZXJHcm91cHMnOm5ld1VzZXJHcnBzLCAndXNlcnMnOiBbdXNyXX19OwogICAgICAgIGF4aW9zLnBvc3QoTklGSV9FTkRQT0lOVCArICcvcG9saWNpZXMnLCBvYmpUb0JlU2VudCwge2h0dHBzQWdlbnR9KQogICAgICAgICAgICAudGhlbihyZXN1bHQgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1BvbGljeSBjcmVhdGVkIHN1Y2Nlc3NmdWxseSAnKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQuZGF0YTsKICAgICAgICAgICAgfSkuY2F0Y2goZXJyb3IgPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0R1cmluZyBjcmVhdGVQb2xpY3kuJyArIGVycm9yKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7Cn0KCi8qKgogKiBVcGRhdGUgUG9saWN5CiAqLwp2YXIgdXBkYXRlUG9saWN5ID0gYXN5bmMgKHBvbGljeSwgYWN0aW9uLCByZXNvdXJjZSwgUEdOYW1lLCB1c2VyR3JwcywgdXNlck5hbWUpID0+IHsKICAgIGNvbnNvbGUubG9nKCJJbnNpZGUgdXBkYXRlUG9saWN5Iik7IAogICAgdmFyIG5ld1VzZXJHcnBzID0gcHJlcGFyZVVHNFBvbGljeShQR05hbWUsIHVzZXJHcnBzLCBhY3Rpb24pOwogICAgYXdhaXQgZ2V0VXNlcihBRE1JTl9VU0VSKS50aGVuKGFkbWluVXNlciA9PnsKICAgICAgICB2YXIgdXNyID0geydyZXZpc2lvbic6IHsndmVyc2lvbic6IDB9LCdpZCc6IGFkbWluVXNlci5pZH07CiAgICAgICAgcG9saWN5LmNvbXBvbmVudC51c2VyR3JvdXBzID0gbmV3VXNlckdycHM7CiAgICAgICAgcG9saWN5LmNvbXBvbmVudC51c2VycyA9IFt1c3JdOwogICAgICAgIGF4aW9zLnB1dChOSUZJX0VORFBPSU5UICsgJy9wb2xpY2llcy8nICsgcG9saWN5LmlkLCBwb2xpY3ksIHtodHRwc0FnZW50fSkKICAgICAgICAgICAgLnRoZW4ocmVzdWx0ID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQb2xpY3kgdXBkYXRlZCBzdWNjZXNzZnVsbHkgJyk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LmRhdGE7CiAgICAgICAgICAgIH0pIC5jYXRjaChlcnJvciA9PiBjb25zb2xlLmxvZygiRXJyb3IgZHVyaW5nIHVwZGF0ZVBvbGljeSAiICsgZXJyb3IpKTsKICAgICAgICB9KTsKfQoKdmFyIHVwc2VydFBvbGljeSA9IGFzeW5jIChhY3Rpb24sIHJlc291cmNlLCBQR05hbWUsIHVzZXJHcnBzLCB1c2VyTmFtZSkgPT4gewogICAgY29uc29sZS5sb2coIkluc2lkZSB1cHNlcnRQb2xpY3kgIiArIGFjdGlvbiArICIgcmVzb3VyY2U6ICIgKyByZXNvdXJjZSk7CiAgICB0cnl7CiAgICAgICAgYXdhaXQgZ2V0UG9saWN5KGFjdGlvbiwgcmVzb3VyY2UsIFBHTmFtZSwgdXNlckdycHMsIHVzZXJOYW1lKQogICAgICAgICAgICAudGhlbihyZXN1bHQgPT57CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiY2hlY2sgcG9saWN5IGV4aXN0ZW5jZSAiKTsgCiAgICAgICAgICAgICAgICBpZihyZXN1bHQgIT0gbnVsbCAmJiByZXN1bHQuY29tcG9uZW50ICE9IG51bGwgJiYgcmVzdWx0LmNvbXBvbmVudC5yZXNvdXJjZSAhPT0gcmVzb3VyY2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygicG9saWN5IGRvZXNuJ3QgZXhpc3QuIGNyZWF0aW5nIGl0Li4uIik7CiAgICAgICAgICAgICAgICAgICAgY3JlYXRlUG9saWN5KGFjdGlvbiwgcmVzb3VyY2UsIFBHTmFtZSwgdXNlckdycHMsIHVzZXJOYW1lKTsKICAgICAgICAgICAgICAgIH0gZWxzZXsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygicG9saWN5IGV4aXN0cy4gdXBkYXRpbmcgaXQuLi4iKTsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVQb2xpY3kocmVzdWx0LCBhY3Rpb24sIHJlc291cmNlLCBQR05hbWUsIHVzZXJHcnBzLCB1c2VyTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5jYXRjaChlcnJvciA9PiBlcnJvcikKICAgIH0gY2F0Y2goZXJyb3Ipe2NvbnNvbGUubG9nKGVycm9yKTt9Cn0KCi8qKgogKiBHZXQgUG9saWN5CiAqLwp2YXIgZ2V0UG9saWN5ID0gKGFjdGlvbiwgcmVzb3VyY2UpID0+IHsKICAgIGNvbnNvbGUubG9nKCJJbnNpZGUgZ2V0UG9saWN5OiAiICsgTklGSV9FTkRQT0lOVCArICcvcG9saWNpZXMvJyArIGFjdGlvbiArIHJlc291cmNlKTsKICAgIHRyeXsKICAgICAgICByZXR1cm4gYXhpb3MuZ2V0KE5JRklfRU5EUE9JTlQgKyAnL3BvbGljaWVzLycgKyBhY3Rpb24gKyByZXNvdXJjZSwge2h0dHBzQWdlbnR9KQogICAgICAgICAgICAudGhlbihyZXMgPT4gcmVzLmRhdGEpCiAgICAgICAgICAgIC5jYXRjaChlcnJvciA9PiBlcnJvcik7CiAgICB9IGNhdGNoKGVycm9yKXtjb25zb2xlLmxvZyhlcnJvcik7fQp9Cgp2YXIgYXNzaWduUG9saWN5ID0gYXN5bmMgKFBHSWQsIFBHTmFtZSwgdXNlck5hbWUpID0+IHsKICAgIHZhciB1c2VyR3JwczsKICAgIHJldHVybiBheGlvcy5nZXQoTklGSV9FTkRQT0lOVCArICcvdGVuYW50cy91c2VyLWdyb3VwcycsIHtodHRwc0FnZW50fSkKICAgICAgICAudGhlbihyZXN1bHQgPT4gewogICAgICAgICAgICBjb25zb2xlLmxvZygibGlzdGluZyB1c2VyIGdycHMuICIpOwogICAgICAgICAgICB1c2VyR3JwcyA9IHJlc3VsdC5kYXRhLnVzZXJHcm91cHM7CiAgICAgICAgICAgIHVwc2VydFBvbGljeShBQ1RJT05fUkVBRCwgICBUWVBFX1BST0NFU1NfR1JPVVAgKyBQR0lkLCBQR05hbWUsIHVzZXJHcnBzLCB1c2VyTmFtZSk7CiAgICAgICAgICAgIHVwc2VydFBvbGljeShBQ1RJT05fV1JJVEUsICBUWVBFX1BST0NFU1NfR1JPVVAgKyBQR0lkLCBQR05hbWUsIHVzZXJHcnBzLCB1c2VyTmFtZSk7CiAgICAgICAgICAgIHVwc2VydFBvbGljeShBQ1RJT05fUkVBRCwgICBUWVBFX1BST1ZFTkFOQ0UgKyBQR0lkLCBQR05hbWUsdXNlckdycHMsIHVzZXJOYW1lKTsKICAgICAgICAgICAgdXBzZXJ0UG9saWN5KEFDVElPTl9XUklURSwgIFRZUEVfT1BFUkFUSU9OICsgUEdJZCwgUEdOYW1lLHVzZXJHcnBzLCB1c2VyTmFtZSk7CiAgICAgICAgICAgIHVwc2VydFBvbGljeShBQ1RJT05fUkVBRCwgICBUWVBFX0RBVEEgKyBQR0lkLCBQR05hbWUsdXNlckdycHMsIHVzZXJOYW1lKTsKICAgICAgICAgICAgdXBzZXJ0UG9saWN5KEFDVElPTl9XUklURSwgIFRZUEVfREFUQSArIFBHSWQsIFBHTmFtZSx1c2VyR3JwcywgdXNlck5hbWUpOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGVycm9yID0+IGNvbnNvbGUubG9nKCdFcnJvciBkdXJpbmcgZ2V0VXNlckdyb3VwICcgKyBlcnJvcikpOwogICAgCn0KCnZhciBwcmVwYXJlVUc0UG9saWN5ID0gKHByb2Nlc3NHcm91cE5hbWUsIGxpc3RVRywgYWN0aW9uKSA9PnsKICAgIHZhciBuYW1lLGlkLHJvbGU7CiAgICB2YXIgb2JqR3JwID0ge307CiAgICB2YXIgbmV3R3JwcyA9IFtdOwogICAgZm9yKHZhciBpPTA7IGk8bGlzdFVHLmxlbmd0aDsgaSsrKXsKICAgICAgICBuYW1lICAgID0gbGlzdFVHW2ldWyJjb21wb25lbnQiXVsnaWRlbnRpdHknXTsKICAgICAgICBpZCAgICAgID0gbGlzdFVHW2ldWyJpZCJdOwogICAgICAgIHJvbGUgICAgPSBuYW1lLnN1YnN0cmluZyhuYW1lLmluZGV4T2YoIjoiKSsxKTsKICAgICAgICBpZihuYW1lLnN1YnN0cmluZygwLG5hbWUuaW5kZXhPZigiOiIpKSA9PT0gcHJvY2Vzc0dyb3VwTmFtZSl7CiAgICAgICAgICAgIGlmKGFjdGlvbiA9PT0gQUNUSU9OX1JFQUQgfHwgKGFjdGlvbiA9PT0gQUNUSU9OX1dSSVRFICYmIHJvbGUgPT09IE5JRklfUk9MRV9NQU5BR0VSKSl7CiAgICAgICAgICAgICAgICBvYmpHcnAgPSB7J3JldmlzaW9uJzogeyd2ZXJzaW9uJzogMH0sJ2lkJzogaWR9OwogICAgICAgICAgICAgICAgbmV3R3Jwcy5wdXNoKG9iakdycCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3R3JwczsKfQoKLyoqCiAqIENoZWNrIHRoZSBleGlzdGVuY2Ugb2YgcHJvY2VzcyBncm91cCBiZWZvcmUgY3JlYXRpbmcgaXQsIGluIG9yZGVyIHRvIGF2b2lkIGR1cGxpY2F0ZXMKICovCmZ1bmN0aW9uIGNoZWNrRXhpc3RlbmNlKHBhcmVudElkLCBwcm9jZXNzR3JvdXBOYW1lLCBhc3NpZ25Sb2xlKSB7CiAgICB2YXIgdXJsID0gTklGSV9FTkRQT0lOVCArICcvZmxvdy9wcm9jZXNzLWdyb3Vwcy8nICsgcGFyZW50SWQgKyAnL3N0YXR1cz9yZWN1cnNpdmU9ZmFsc2UnOwogICAgcmV0dXJuIGF4aW9zLmdldCh1cmwse2h0dHBzQWdlbnR9KQogICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICAgICAgdmFyIHBnSWQgPSByZWFkUmVjdXJzaXZlUEcocmVzcG9uc2UuZGF0YS5wcm9jZXNzR3JvdXBTdGF0dXMuYWdncmVnYXRlU25hcHNob3QsIHByb2Nlc3NHcm91cE5hbWUpOyAgCiAgICAgICAgICAgIHJldHVybiBbcGFyZW50SWQsIHByb2Nlc3NHcm91cE5hbWUsIHBnSWQsIGFzc2lnblJvbGVdCiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goZXJyb3IgPT4gW3BhcmVudElkLCBwcm9jZXNzR3JvdXBOYW1lLCAwLCBhc3NpZ25Sb2xlXSk7Cn0KCmZ1bmN0aW9uIHJ1blRhc2socmVzdWx0LCBzcGVjLCBhc3NpZ25Sb2xlKSB7CiAgICBjb25zb2xlLmxvZygiSW5zaWRlIHJ1blRhc2siKTsKICAgIGNvbnNvbGUubG9nKHJlc3VsdCk7IGNvbnNvbGUubG9nKGFzc2lnblJvbGUpOwogICAgdmFyIHBhcmVudElkID0gInJvb3QiOwogICAgaWYocmVzdWx0ICE9IHVuZGVmaW5lZCAmJiByZXN1bHQgIT0gbnVsbCkgcGFyZW50SWQgPSByZXN1bHRbMF07CiAgICByZXR1cm4gY2hlY2tFeGlzdGVuY2UocGFyZW50SWQsIHNwZWMsIGFzc2lnblJvbGUpOwp9Cgphc3luYyBmdW5jdGlvbiBwcm9jZXNzR3JvdXBzVXBzZXJ0KHByb2Nlc3NHcm91cHNUb1Vwc2VydCwgcm9sZU5hbWUsIHVzZXJuYW1lKXsKICAgIGNvbnN0IHN0YXJ0ZXJQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKFsicm9vdCIsIDAsIDBdKTsKICAgIGNvbnN0IGFjdGlvbiAgICAgICAgICAgID0gcmVzdWx0ID0+IHtpZihBcnJheS5pc0FycmF5KHJlc3VsdCkpIHJldHVybiBjcmVhdGVQcm9jZXNzR3JvdXAocmVzdWx0WzBdLCByZXN1bHRbMV0sIHJlc3VsdFsyXSwgcmVzdWx0WzNdLCByb2xlTmFtZSwgdXNlcm5hbWUpfTsKICAgIHZhciBjb3VudCA9IHByb2Nlc3NHcm91cHNUb1Vwc2VydC5sZW5ndGg7CiAgICBhd2FpdCBwcm9jZXNzR3JvdXBzVG9VcHNlcnQucmVkdWNlKAogICAgICAgIChwLCBzcGVjLCBpbmRleCkgPT4gcC50aGVuKChyZXN1bHQpID0+IHJ1blRhc2socmVzdWx0LCBzcGVjLCBpbmRleCA9PT0gY291bnQtMSkudGhlbihhY3Rpb24pKSwKICAgICAgICBzdGFydGVyUHJvbWlzZQogICAgKTsKfQoKYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0dyb3Vwc0xpc3Qocm9sZXMsIHVzZXJuYW1lKXsKICAgIHZhciB1c2VyID0gYXdhaXQgZ2V0VXNlcih1c2VybmFtZSk7CiAgICBpZih1c2VyICE9IHVuZGVmaW5lZCAmJiB1c2VyICE9PSBudWxsICYmIHVzZXJuYW1lICE9PSBBRE1JTl9VU0VSKQogICAgICAgIGF3YWl0IGRlbGV0ZVVzZXIodXNlci5pZCk7IC8vIHVwZGF0ZVVzZXIodXNlci5pZCwgdXNlcm5hbWUpOyAKICAgIHZhciBvcmdhbml6YXRpb25zID0gW107ICAgCiAgICB2YXIgcm9sZU5hbWUgPSAiIjsKICAgIGZvciAodmFyIG9yZyBpbiByb2xlcykgewogICAgICAgIGNvbnNvbGUubG9nKCdJbnNpZGUgbG9vcCBvZiBvcmdzIDogJyArIG9yZyArICIgIiArIHJvbGVzW29yZ10pOyAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgcm9sZU5hbWUgPSByb2xlc1tvcmddOwogICAgICAgIGlmKG9yZy5pbmRleE9mKCItPiIpID4wKXsKICAgICAgICAgICAgb3JnYW5pemF0aW9ucyA9IG9yZy5zcGxpdCgiLT4iKTsKICAgICAgICB9IGVsc2V7CiAgICAgICAgICAgIG9yZ2FuaXphdGlvbnMgPSBbXTsKICAgICAgICAgICAgb3JnYW5pemF0aW9ucy5wdXNoKG9yZyk7CiAgICAgICAgfQogICAgICAgIGF3YWl0IHByb2Nlc3NHcm91cHNVcHNlcnQob3JnYW5pemF0aW9ucywgcm9sZU5hbWUsIHVzZXJuYW1lKTsKICAgIH0KfQpleHBvcnRzLmhhbmRsZXIgPSAoY29udGV4dCwgZXZlbnQpID0+IHsKICAgIGV4dHJhY3RDbGFpbXMoY29udGV4dCwgZXZlbnQuaGVhZGVycywgZnVuY3Rpb24oY2xhaW1zKSB7CiAgICAgICAgdHJ5ewogICAgICAgICAgICAvLyBleHRyYWN0IHJvbGVzCiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm9XaXRoKCdSb2xlcyBmcm9tIEFBQyBmb3IgTmlmaTogJywgY2xhaW1zW0NVU1RPTUNMQUlNX1JPTEVTXSk7CiAgICAgICAgICAgIHZhciBuYW1lICA9IGNsYWltcy51c2VybmFtZTsKICAgICAgICAgICAgdmFyIHVzZXJuYW1lID0gY2xhaW1zLmVtYWlsOyAgCiAgICAgICAgICAgIHZhciByb2xlcyA9IGNsYWltc1tDVVNUT01DTEFJTV9ST0xFU107ICAgIAogICAgICAgICAgICB2YXIgb3JnYW5pemF0aW9ucyA9IFtdOyAgIAogICAgICAgICAgICB2YXIgcm9sZU5hbWUgPSAiIjsKICAgICAgICAgICAgaWYocm9sZXMgIT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgIHByb2Nlc3NHcm91cHNMaXN0KHJvbGVzLCB1c2VybmFtZSk7CiAgICAgICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKHJvbGVzKTsKICAgICAgICAgICAgfSBlbHNlewogICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mb1dpdGgoJ01pc3Npbmcgcm9sZXMgZnJvbSBBQUMuIENoZWNrIHRoZSBjbGFpbSBtYXBwaW5nJykKICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdNaXNzaW5nIHJvbGVzIGZyb20gQUFDLiBDaGVjayB0aGUgY2xhaW0gbWFwcGluZyd9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA1MDApKTsKICAgICAgICAgICAgfSAKICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjayhyb2xlcyk7CiAgICAgICAgfSBjYXRjaChlcnIpewogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvV2l0aCgnTklGSSBjYWxsIGZhaWx1cmUnICsgZXJyKQogICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKG5ldyBjb250ZXh0LlJlc3BvbnNlKHttZXNzYWdlOiAnTklGSSBjYWxsIGZhaWx1cmUnLCBlcnI6IGVycn0sIHt9LCAnYXBwbGljYXRpb24vanNvbicsIDUwMCkpOwogICAgICAgIH0KICAgICAgICAKICAgIH0pOwp9Owo=
    image: nuclio-sys-nodejs-nifi-connector
    registry: {{ .Values.registry.pushPullUrl }}
    runtimeAttributes:
      repositories: []
    timestamp: 1595414065
  description: Provision Users,ProcessGroup, Policy for NiFi
  env:
  - name: AACJWKURL
    value: {{ .Values.sysfunction.nifi.aacjwkurl }}
  - name: AACCLIENTID
    value: {{ .Values.sysfunction.nifi.aacclientid }}
  - name: NIFIENDPOINT
    value: {{ .Values.sysfunction.nifi.nifiendpoint }}
  eventTimeout: ""
  handler: main:handler
  image: {{ .Values.registry.pushPullUrl }}/nuclio-sys-nodejs-nifi-connector:latest
  imageHash: "1595414013543366540"
  imagePullSecrets: registry-credentials
  loggerSinks:
  - level: debug
  maxReplicas: 1
  minReplicas: 1
  platform: {}
  readinessTimeoutSeconds: 60
  resources: {}
  runRegistry: {{ .Values.registry.pushPullUrl }}
  runtime: nodejs
  serviceType: NodePort
  targetCPU: 75
  version: -1
  volumes:
  - volume:
      name: certificates
      secret:
        secretName: nifi-user-cert-pem
    volumeMount:
      mountPath: /certificates
      name: certificates
status:
  httpPort: 30068
  scaleToZero:
    lastScaleEvent: resourceUpdated
    lastScaleEventTime: "2020-07-22T10:34:39.935953908Z"
  state: ready
{{- end }}
