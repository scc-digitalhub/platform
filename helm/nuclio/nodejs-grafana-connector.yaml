apiVersion: nuclio.io/v1beta1
kind: NuclioFunction
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"nuclio.io/v1beta1","kind":"NuclioFunction","metadata":{"annotations":{},"generation":1,"labels":{"nuclio.io/project-name":"grafana"},"name":"nodejs-grafana-connector","namespace":"sys","selfLink":"/apis/nuclio.io/v1beta1/namespaces/sys/nucliofunctions/nodejs-grafana-connector"},"spec":{"alias":"latest","build":{"codeEntryType":"sourceCode","commands":["npm install --global moment","npm install --global jsonwebtoken","npm install --global axios","npm install --global jwks-rsa"],"functionSourceCode":"dmFyIGp3dCA9IHJlcXVpcmUoJ2pzb253ZWJ0b2tlbicpOwp2YXIgYXhpb3MgPSByZXF1aXJlKCdheGlvcycpOwoKdmFyIEpXS1NfVVJJICAgICAgICAgICAgICAgICAgICA9IHByb2Nlc3MuZW52LkFBQ0pXS1VSTDsKdmFyIFJFU09VUkNFX0lEICAgICAgICAgICAgICAgICA9IHByb2Nlc3MuZW52LkFBQ1JFU09VUkNFSUQ7CnZhciBHUkFGQU5BX0VORFBPSU5UICAgICAgICAgICAgPSBwcm9jZXNzLmVudi5HUkFGQU5BRU5EUE9JTlQ7CnZhciBHUkFGQU5BX0FVVEggICAgICAgICAgICAgICAgPSBwcm9jZXNzLmVudi5HUkFGQU5BQVVUSDsKdmFyIEdSQUZBTkFfVVNFUl9QQVNTV19ERUZBVUxUICA9IHByb2Nlc3MuZW52LkdSQUZBTkFfVVNFUl9QQVNTV19ERUZBVUxUOwp2YXIgQ1VTVE9NQ0xBSU1fUk9MRVMgPSAnZ3JhZmFuYS9yb2xlcycKCi8qKgoqIENoZWNrIEpXVCB0b2tlbiBpcyBwcmVzZW50LCBpcyB2YWxpZCB3aXRoIHJlc3BlY3QgdG8gdGhlIHByZWNvbmZpZ3VyZWQgSldLUywgYW5kIGlzIG5vdCBleHBpcmVkLgoqIElmIHRoZSBjaGVjayBpcyBwYXNzZWQsIHRoZW4gcmV0dXJuIGV4dHJhY3RlZCBjbGFpbXMuCiovCnZhciBleHRyYWN0Q2xhaW1zID0gYXN5bmMoY29udGV4dCwgaGVhZGVycywgY2FsbGJhY2spID0+IHsKZm9yICh2YXIgaCBpbiBoZWFkZXJzKSB7CiAgICBpZiAoaC50b0xvd2VyQ2FzZSgpID09PSAnYXV0aG9yaXphdGlvbicgJiYgaGVhZGVyc1toXSkgewogICAgICAgIC8vIEV4cGVjdCBoZWFkZXIgaW4gdGhlIGZvcm0gQmVhcmVyIDxKV1Q+CiAgICAgICAgdmFyIHRva2VuID0gaGVhZGVyc1toXS5zdWJzdHJpbmcoaGVhZGVyc1toXS5pbmRleE9mKCcgJykrMSk7CiAgICAgICAgdmFyIGp3a3NDbGllbnQgPSByZXF1aXJlKCdqd2tzLXJzYScpOwogICAgICAgIHZhciBjbGllbnQgPSBqd2tzQ2xpZW50KHsKICAgICAgICAgICAgandrc1VyaTogSldLU19VUkkKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBnZXRLZXkoaGVhZGVyLCBrZXlDYWxsYmFjayl7CiAgICAgICAgICAgIGlmIChjb250ZXh0LmtleSkgewogICAgICAgICAgICAgICAga2V5Q2FsbGJhY2sobnVsbCwgY29udGV4dC5rZXkpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNsaWVudC5nZXRTaWduaW5nS2V5KGhlYWRlci5raWQsIGZ1bmN0aW9uKGVyciwga2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgc2lnbmluZ0tleSA9IGtleSA/IGtleS5wdWJsaWNLZXkgfHwga2V5LnJzYVB1YmxpY0tleSA6IG51bGw7CiAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdOZXcga2V5ICcgKyBzaWduaW5nS2V5KTsKICAgICAgICAgICAgICAgIGlmKHNpZ25pbmdLZXkgPT09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjayhuZXcgY29udGV4dC5SZXNwb25zZSh7bWVzc2FnZTogJ01pc3Npbmcgc2lnbmluZyBrZXknfSwge30sICdhcHBsaWNhdGlvbi9qc29uJywgNDAxKSk7CiAgICAgICAgICAgICAgICBjb250ZXh0LmtleSA9IHNpZ25pbmdLZXk7CiAgICAgICAgICAgICAgICBrZXlDYWxsYmFjayhudWxsLCBzaWduaW5nS2V5KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogIAogICAgICAgIHZhciBvcHRpb25zID0geyBhdWRpZW5jZTogUkVTT1VSQ0VfSUQgfTsKICAgICAgICAgand0LnZlcmlmeSh0b2tlbiwgZ2V0S2V5LCBvcHRpb25zLCBmdW5jdGlvbihlcnIsIGRlY29kZWQpIHsKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mb1dpdGgoJ1ZlcmlmeSBqd3Q6IGNsYWltczogJywgZGVjb2RlZCk7CiAgICAgICAgICAgIGlmICghZGVjb2RlZCkgewkKICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdJbmNvcnJlY3Qgc2lnbmF0dXJlOiAnICwgZXJyOiBlcnJ9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA0MDEpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFjayhkZWNvZGVkKTsKICAgICAgICB9KTsgCiAgICAgICAgcmV0dXJuOyAKICAgIH0KfQpjb250ZXh0LmNhbGxiYWNrKG5ldyBjb250ZXh0LlJlc3BvbnNlKHttZXNzYWdlOiAnTWlzc2luZyB0b2tlbid9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA0MDApKTsKfSAKCi8qKgogKiBDaGVjayBpZiB0aGUgb3JnYW5pemF0aW9uIGV4aXN0cyBpbiBvcmRlciB0byBwcm92aXNpb24gaXQgYW5kIGFzc2lnbiB0aGUgcHJvcGVyIHJpZ2h0cyB0byB0aGUgdXNlcgogKiBpZiBub3QsIGNyZWF0ZSB0aGUgb3JnYW5pemF0aW9uCiAqLwp2YXIgaGFuZGxlT3JnYW5pemF0aW9ucyA9IGFzeW5jIChjb250ZXh0LCBvcmcsIHJvbGUsIHVzZXJuYW1lLCB1c2VySWQpID0+IHsKICAgIHZhciBvcmdfY2FsbHMgICAgICAgID0gW107CiAgICB2YXIgb3JnSWQgICAgICAgICAgICA9ICIiOwogICAgCiAgICBvcmdfY2FsbHMucHVzaCggYXhpb3MuZ2V0KEdSQUZBTkFfRU5EUE9JTlQgKyAnL2FwaS9vcmdzL25hbWUvJyArIG9yZywge2hlYWRlcnM6IHsnQXV0aG9yaXphdGlvbic6IEdSQUZBTkFfQVVUSH19KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdPcmdhbml6YXRpb24gJyArIG9yZyArICcgYWxyZWFkeSBleGlzdHMgaW4gR3JhZmFuYS4nLCByZXMpOwogICAgICAgICAgICBvcmdJZCA9IHJlcy5kYXRhLmlkOyAgICAgICAgICAgIAogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJvcmdhbml6YXRpb24gSWQ6ICIgKyBvcmdJZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBhc3NpZ24gdGhlIHByb3BlciByb2xlIHRvIHRoZSB1c2VyIGluc2lkZSB0aGUgb3JnYW5pemF0aW9uCiAgICAgICAgICAgIGhhbmRsZVVzZXJSb2xlcyhjb250ZXh0LCBvcmdJZCwgdXNlcm5hbWUsIHVzZXJJZCwgcm9sZSk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIHJldHVybiBheGlvcy5wb3N0KEdSQUZBTkFfRU5EUE9JTlQgKyAnL2FwaS9vcmdzJywge25hbWU6IG9yZ30sIHtoZWFkZXJzOiB7J0F1dGhvcml6YXRpb24nOiBHUkFGQU5BX0FVVEh9fSkKICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdPcmdhbml6YXRpb24gZG9lcyBub3QgZXhpc3QgaW4gR3JhZmFuYS5DcmVhdGluZyBvcmdhbml6YXRpb246ICcgKyBvcmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JnSWQgPSByZXMuZGF0YS5vcmdJZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIm9yZ2FuaXphdGlvbiBJZDogIiArIG9yZ0lkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXNzaWduIHRoZSBwcm9wZXIgcm9sZSB0byB0aGUgdXNlciBpbnNpZGUgdGhlIG9yZ2FuaXphdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlVXNlclJvbGVzKGNvbnRleHQsIG9yZ0lkLCB1c2VybmFtZSwgdXNlcklkLCByb2xlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yZ19jYWxscy5wdXNoKCdPcmdhbml6YXRpb24gZG9lcyBub3QgZXhpc3QgaW4gR3JhZmFuYS5DcmVhdGluZyBvcmdhbml6YXRpb246ICcgKyBvcmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdPcmdhbml6YXRpb24gZG9lcyBub3QgZXhpc3QgaW4gR3JhZmFuYS5DcmVhdGluZyBvcmdhbml6YXRpb246ICcgKyBvcmc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnRXJyb3Igd2hpbGUgY3JlYXRpbmcgb3JnYW5pemF0aW9uOiAnICsgb3JnICsgIiAiICsgZXJyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdHUkFGQU5BIGNhbGwgZmFpbHVyZTogJyArICdFcnJvciB3aGlsZSBjcmVhdGluZyBvcmdhbml6YXRpb246ICcgKyBvcmcgKyAiICIsIGVycjogZXJyfSwge30sICdhcHBsaWNhdGlvbi9qc29uJywgNTAwKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB9KTsgCiAgICAgICAgfSkKICAgICk7CiAgICByZXR1cm4gb3JnX2NhbGxzOyAgICAKfTsKLyoqCiAqIENyZWF0ZSB0aGUgZ2xvYmFsIHVzZXIgCiAqLwp2YXIgcHJvdmlzaW9uRW50aXRpZXMgPSBhc3luYyAoY29udGV4dCwgbmFtZSwgdXNlcmVtYWlsLCByb2xlcykgPT4gewogICAgdmFyIG9ialRvQmVTZW50ID0ge25hbWUgOiBuYW1lLCBlbWFpbCA6IHVzZXJlbWFpbCwgcGFzc3dvcmQgOiBHUkFGQU5BX1VTRVJfUEFTU1dfREVGQVVMVH07CiAgICB2YXIgdXNlcklkID0gMDsKICAgIGNvbnRleHQubG9nZ2VyLmluZm9XaXRoKCJIYW5kbGluZyBVc2VyIGNyZWF0aW9uOiIgKyBuYW1lICsgIiB3aXRoIHVzZXJuYW1lOiAiICsgdXNlcmVtYWlsKTsKICAgIHVzZXJJZCA9IGF3YWl0IGF4aW9zLmdldChHUkFGQU5BX0VORFBPSU5UICsgJy9hcGkvdXNlcnMvbG9va3VwP2xvZ2luT3JFbWFpbD0nICsgdXNlcmVtYWlsLCB7aGVhZGVyczogeydBdXRob3JpemF0aW9uJzogR1JBRkFOQV9BVVRIfX0pCiAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKXsKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnR2xvYmFsIHVzZXIgJyArIG5hbWUgKyAnICcgKyB1c2VyZW1haWwgKyAnIGFscmVhZHkgZXhpc3RzIGluIEdyYWZhbmEuJywgcmVzKTsKICAgICAgICAgICAgdXNlcklkID0gcmVzLmRhdGEuaWQ7CiAgICAgICAgICAgIC8vIHByb3Zpc2lvbmluZyBvcmdhbml6YXRpb25zCiAgICAgICAgICAgIGZvciAodmFyIG9yZyBpbiByb2xlcykgewogICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnSW5zaWRlIGxvb3Agb2Ygb3JncyA6ICcgKyBvcmcgKyAiICIgKyByb2xlc1tvcmddKTsKICAgICAgICAgICAgICAgIHJvbGVOYW1lID0gcm9sZXNbb3JnXTsKICAgICAgICAgICAgICAgIGhhbmRsZU9yZ2FuaXphdGlvbnMoY29udGV4dCwgb3JnLCByb2xlTmFtZSwgdXNlcmVtYWlsLCB1c2VySWQpOwogICAgICAgICAgICB9ICAgICAgICAgCiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgYXhpb3MucG9zdChHUkFGQU5BX0VORFBPSU5UICsgJy9hcGkvYWRtaW4vdXNlcnMnLCBvYmpUb0JlU2VudCwge2hlYWRlcnM6IHsnQXV0aG9yaXphdGlvbic6IEdSQUZBTkFfQVVUSH19KQogICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnVXNlciAnICsgbmFtZSArICcgc3VjY2Vzc2Z1bGx5IGNyZWF0ZWQgaW4gR3JhZmFuYS4nKTsKICAgICAgICAgICAgICAgICAgICB1c2VySWQgPSByZXMuZGF0YS5pZDsKICAgICAgICAgICAgICAgICAgICAvLyBwcm92aXNpb25pbmcgb3JnYW5pemF0aW9ucwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG9yZyBpbiByb2xlcykgewogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdJbnNpZGUgbG9vcCBvZiBvcmdzIDogJyArIG9yZyArICIgIiArIHJvbGVzW29yZ10pOwogICAgICAgICAgICAgICAgICAgICAgICByb2xlTmFtZSA9IHJvbGVzW29yZ107CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZU9yZ2FuaXphdGlvbnMoY29udGV4dCwgb3JnLCByb2xlTmFtZSwgdXNlcmVtYWlsLCB1c2VySWQpOwogICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5kYXRhLmlkOwogICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ0Vycm9yIHdoaWxlIGNyZWF0aW5nIHVzZXI6ICcgKyBuYW1lICsgZXJyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjayhuZXcgY29udGV4dC5SZXNwb25zZSh7bWVzc2FnZTogJ0dSQUZBTkEgY2FsbCBmYWlsdXJlOiAnICsgJ0Vycm9yIHdoaWxlIGNyZWF0aW5nIHVzZXI6ICcgKyBuYW1lLCBlcnI6IGVycn0sIHt9LCAnYXBwbGljYXRpb24vanNvbicsIDUwMCkpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwp9OwoKLyoqCiAqICBBc3NpZ24gdGhlIHVzZXIgdG8gdGhlIHByb3BlciByb2xlIChBZG1pbiwgRWRpdG9yLCBWaWV3ZXIpCiAqLwp2YXIgaGFuZGxlVXNlclJvbGVzID0gYXN5bmMgKGNvbnRleHQsIG9yZ0lkLCB1c2VybmFtZSwgdXNlcklkLCByb2xlTmFtZSkgPT4gewogICAgdmFyIG9ialRvQmVTZW50ID0ge2xvZ2luT3JFbWFpbCA6IHVzZXJuYW1lLCAicm9sZSIgOiByb2xlTmFtZX07CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvV2l0aCgiSGFuZGxpbmcgUm9sZXMgb2YgdXNlcjoiICsgdXNlcm5hbWUgKyAiIGluIG9yZ2FuaXphdGlvbklkLiAiICsgb3JnSWQgKyAiLiBvYmpUb0JlU2VudCAiICwgb2JqVG9CZVNlbnQpOwogICAgYXhpb3MucG9zdChHUkFGQU5BX0VORFBPSU5UICsgJy9hcGkvb3Jncy8nICsgb3JnSWQgKyAnL3VzZXJzJywgb2JqVG9CZVNlbnQsIHtoZWFkZXJzOiB7J0F1dGhvcml6YXRpb24nOiBHUkFGQU5BX0FVVEh9fSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnUm9sZSAnICsgcm9sZU5hbWUgKyAnIHN1Y2Nlc3NmdWxseSBhc3NpZ25lZCB0byB1c2VyOiAnICsgdXNlcm5hbWUpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnVXNlciBpcyBhbHJlYWR5IG1lbWJlciBvZiB0aGlzIG9yZ2FuaXphdGlvbi4gU2V0dGluZyB0aGUgbmV3IHJvbGUgdG8gdGhlIG9yZ2FuaXphdGlvbiAnICsgb3JnSWQpOwogICAgICAgICAgICAgICAgb2JqVG9CZVNlbnQgPSB7InJvbGUiIDogcm9sZU5hbWV9OwogICAgICAgICAgICAgICAgYXhpb3MucGF0Y2goR1JBRkFOQV9FTkRQT0lOVCArICcvYXBpL29yZ3MvJyArIG9yZ0lkICsgJy91c2Vycy8nICsgdXNlcklkLCBvYmpUb0JlU2VudCwge2hlYWRlcnM6IHsnQXV0aG9yaXphdGlvbic6IEdSQUZBTkFfQVVUSH19KQogICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ1JvbGUgJyArIHJvbGVOYW1lICsgJyBzdWNjZXNzZnVsbHkgYXNzaWduZWQgdG8gdXNlcjogJyArIHVzZXJuYW1lKTsKICAgICAgICAgICAgICAgICAgICB9KSAuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdHUkFGQU5BIGNhbGwgZmFpbHVyZTogJyArICAnRXJyb3Igd2hpbGUgYXNzaWduaW5nIHJvbGUgJyArIHJvbGVOYW1lICsgJyB0byB1c2VyOiAnICsgdXNlcm5hbWUsIGVycjogZXJyfSwge30sICdhcHBsaWNhdGlvbi9qc29uJywgNTAwKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfSk7Cn07CmV4cG9ydHMuaGFuZGxlciA9IGFzeW5jKGNvbnRleHQsIGV2ZW50KSA9PiB7CiAgICBleHRyYWN0Q2xhaW1zKGNvbnRleHQsIGV2ZW50LmhlYWRlcnMsIGZ1bmN0aW9uKGNsYWltcykgewogICAgICAgIHRyeXsKICAgICAgICAgICAgLy8gZXh0cmFjdCByb2xlcwogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvV2l0aCgnUm9sZXMgZnJvbSBBQUMgZm9yIEdyYWZhbmE6ICcsIGNsYWltc1tDVVNUT01DTEFJTV9ST0xFU10pOwogICAgICAgICAgICB2YXIgbmFtZSAgPSBjbGFpbXMudXNlcm5hbWU7CiAgICAgICAgICAgIHZhciB1c2VybmFtZSA9IGNsYWltcy5lbWFpbDsgIAogICAgICAgICAgICB2YXIgcm9sZXMgPSBjbGFpbXNbQ1VTVE9NQ0xBSU1fUk9MRVNdOyAgICAgICAKICAgICAgICAgICAgaWYocm9sZXMgIT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgZ2xvYmFsIHVzZXIsIHRoZSBvcmdhbml6YXRpb25zIGFuZCBhc3NpbmcgdGhlIHByb3BlciByb2xlcyB0byB0aGUgdXNlcgogICAgICAgICAgICAgICAgcHJvdmlzaW9uRW50aXRpZXMoY29udGV4dCwgbmFtZSwgdXNlcm5hbWUsIHJvbGVzKTsKICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2socm9sZXMpOwogICAgICAgICAgICB9IGVsc2V7CiAgICAgICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKG5ldyBjb250ZXh0LlJlc3BvbnNlKHttZXNzYWdlOiAnTWlzc2luZyByb2xlcyBmcm9tIEFBQy4gQ2hlY2sgdGhlIGNsYWltIG1hcHBpbmcnfSwge30sICdhcHBsaWNhdGlvbi9qc29uJywgNTAwKSk7CiAgICAgICAgICAgIH0gCiAgICAgICAgfSBjYXRjaChlcnIpewogICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKG5ldyBjb250ZXh0LlJlc3BvbnNlKHttZXNzYWdlOiAnR1JBRkFOQSBjYWxsIGZhaWx1cmUnLCBlcnI6IGVycn0sIHt9LCAnYXBwbGljYXRpb24vanNvbicsIDUwMCkpOwogICAgICAgIH0gICAgICAKICAgIH0pOwp9Owo=","registry":"scltestacr.azurecr.io","runtimeAttributes":{"repositories":[]},"timestamp":1586973494},"description":"Provision Users,Organizations, Roles for Grafana","env":[{"name":"AACJWKURL","value":"https://aac.kube-test.smartcommunitylab.it/jwk"},{"name":"AACRESOURCEID","value":"3ee98780-48c2-4cea-bf9d-c8bdb5855599"},{"name":"GRAFANAAUTH","value":"Basic YWRtaW46V2J2OWFweENIYTF1RGRmb1BNWTk="},{"name":"GRAFANAENDPOINT","value":"https://grafana.kube-test.smartcommunitylab.it"},{"name":"GRAFANA_USER_PASSW_DEFAULT","value":"password"}],"eventTimeout":"","handler":"main:handler","image":"scltestacr.azurecr.io/nuclio-sys-processor:latest","imageHash":"1587051122690885383","imagePullSecrets":"registry-credentials","loggerSinks":[{"level":"debug"}],"maxReplicas":1,"minReplicas":1,"platform":{},"readinessTimeoutSeconds":60,"resources":{},"runtime":"nodejs","serviceType":"NodePort","targetCPU":75,"version":-1},"status":{"httpPort":31674,"scaleToZero":{"lastScaleEvent":"resourceUpdated","lastScaleEventTime":"2020-04-16T15:32:15.389251027Z"},"state":"ready"}}
  creationTimestamp: "2020-04-18T14:18:13Z"
  generation: 48
  labels:
    nuclio.io/project-name: grafana
  name: nodejs-grafana-connector
  namespace: sys
  resourceVersion: "15805749"
  selfLink: /apis/nuclio.io/v1beta1/namespaces/sys/nucliofunctions/nodejs-grafana-connector
  uid: 0787744b-d95a-4f62-91e4-b26448536358
spec:
  alias: latest
  build:
    codeEntryType: sourceCode
    commands:
    - npm install --global moment
    - npm install --global jsonwebtoken
    - npm install --global axios
    - npm install --global jwks-rsa
    - npm install --global randomstring
    functionSourceCode: dmFyIGp3dCA9IHJlcXVpcmUoJ2pzb253ZWJ0b2tlbicpOwp2YXIgYXhpb3MgPSByZXF1aXJlKCdheGlvcycpOwp2YXIgcmFuZG9tU3RyID0gcmVxdWlyZSgncmFuZG9tc3RyaW5nJyk7Cgp2YXIgSldLU19VUkkgICAgICAgICAgICAgICAgICAgID0gcHJvY2Vzcy5lbnYuQUFDSldLVVJMOwp2YXIgUkVTT1VSQ0VfSUQgICAgICAgICAgICAgICAgID0gcHJvY2Vzcy5lbnYuQUFDUkVTT1VSQ0VJRDsKdmFyIEdSQUZBTkFfRU5EUE9JTlQgICAgICAgICAgICA9IHByb2Nlc3MuZW52LkdSQUZBTkFFTkRQT0lOVDsKdmFyIEdSQUZBTkFfQVVUSCAgICAgICAgICAgICAgICA9IHByb2Nlc3MuZW52LkdSQUZBTkFBVVRIOwp2YXIgR1JBRkFOQV9VU0VSX1BBU1NXX0RFRkFVTFQgID0gcHJvY2Vzcy5lbnYuR1JBRkFOQV9VU0VSX1BBU1NXX0RFRkFVTFQ7CnZhciBDVVNUT01DTEFJTV9ST0xFUyA9ICdncmFmYW5hL3JvbGVzJwoKLyoqCiogQ2hlY2sgSldUIHRva2VuIGlzIHByZXNlbnQsIGlzIHZhbGlkIHdpdGggcmVzcGVjdCB0byB0aGUgcHJlY29uZmlndXJlZCBKV0tTLCBhbmQgaXMgbm90IGV4cGlyZWQuCiogSWYgdGhlIGNoZWNrIGlzIHBhc3NlZCwgdGhlbiByZXR1cm4gZXh0cmFjdGVkIGNsYWltcy4KKi8KdmFyIGV4dHJhY3RDbGFpbXMgPSBhc3luYyhjb250ZXh0LCBoZWFkZXJzLCBjYWxsYmFjaykgPT4gewpmb3IgKHZhciBoIGluIGhlYWRlcnMpIHsKICAgIGlmIChoLnRvTG93ZXJDYXNlKCkgPT09ICdhdXRob3JpemF0aW9uJyAmJiBoZWFkZXJzW2hdKSB7CiAgICAgICAgLy8gRXhwZWN0IGhlYWRlciBpbiB0aGUgZm9ybSBCZWFyZXIgPEpXVD4KICAgICAgICB2YXIgdG9rZW4gPSBoZWFkZXJzW2hdLnN1YnN0cmluZyhoZWFkZXJzW2hdLmluZGV4T2YoJyAnKSsxKTsKICAgICAgICB2YXIgandrc0NsaWVudCA9IHJlcXVpcmUoJ2p3a3MtcnNhJyk7CiAgICAgICAgdmFyIGNsaWVudCA9IGp3a3NDbGllbnQoewogICAgICAgICAgICBqd2tzVXJpOiBKV0tTX1VSSQogICAgICAgIH0pOwogICAgICAgIGZ1bmN0aW9uIGdldEtleShoZWFkZXIsIGtleUNhbGxiYWNrKXsKICAgICAgICAgICAgaWYgKGNvbnRleHQua2V5KSB7CiAgICAgICAgICAgICAgICBrZXlDYWxsYmFjayhudWxsLCBjb250ZXh0LmtleSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xpZW50LmdldFNpZ25pbmdLZXkoaGVhZGVyLmtpZCwgZnVuY3Rpb24oZXJyLCBrZXkpIHsKICAgICAgICAgICAgICAgIHZhciBzaWduaW5nS2V5ID0ga2V5ID8ga2V5LnB1YmxpY0tleSB8fCBrZXkucnNhUHVibGljS2V5IDogbnVsbDsKICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ05ldyBrZXkgJyArIHNpZ25pbmdLZXkpOwogICAgICAgICAgICAgICAgaWYoc2lnbmluZ0tleSA9PT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKG5ldyBjb250ZXh0LlJlc3BvbnNlKHttZXNzYWdlOiAnTWlzc2luZyBzaWduaW5nIGtleSd9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA0MDEpKTsKICAgICAgICAgICAgICAgIGNvbnRleHQua2V5ID0gc2lnbmluZ0tleTsKICAgICAgICAgICAgICAgIGtleUNhbGxiYWNrKG51bGwsIHNpZ25pbmdLZXkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgICAgdmFyIG9wdGlvbnMgPSB7IGF1ZGllbmNlOiBSRVNPVVJDRV9JRCB9OwogICAgICAgICBqd3QudmVyaWZ5KHRva2VuLCBnZXRLZXksIG9wdGlvbnMsIGZ1bmN0aW9uKGVyciwgZGVjb2RlZCkgewogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvV2l0aCgnVmVyaWZ5IGp3dDogY2xhaW1zOiAnLCBkZWNvZGVkKTsKICAgICAgICAgICAgaWYgKCFkZWNvZGVkKSB7CQogICAgICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjayhuZXcgY29udGV4dC5SZXNwb25zZSh7bWVzc2FnZTogJ0luY29ycmVjdCBzaWduYXR1cmU6ICcgLCBlcnI6IGVycn0sIHt9LCAnYXBwbGljYXRpb24vanNvbicsIDQwMSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrKGRlY29kZWQpOwogICAgICAgIH0pOyAKICAgICAgICByZXR1cm47IAogICAgfQp9CmNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdNaXNzaW5nIHRva2VuJ30sIHt9LCAnYXBwbGljYXRpb24vanNvbicsIDQwMCkpOwp9IAoKLyoqCiAqIENoZWNrIGlmIHRoZSBvcmdhbml6YXRpb24gZXhpc3RzIGluIG9yZGVyIHRvIHByb3Zpc2lvbiBpdCBhbmQgYXNzaWduIHRoZSBwcm9wZXIgcmlnaHRzIHRvIHRoZSB1c2VyCiAqIGlmIG5vdCwgY3JlYXRlIHRoZSBvcmdhbml6YXRpb24KICovCnZhciBoYW5kbGVPcmdhbml6YXRpb25zID0gYXN5bmMgKGNvbnRleHQsIG9yZywgcm9sZSwgdXNlcm5hbWUsIHVzZXJJZCkgPT4gewogICAgdmFyIG9yZ19jYWxscyAgICAgICAgPSBbXTsKICAgIHZhciBvcmdJZCAgICAgICAgICAgID0gIiI7CiAgICAKICAgIG9yZ19jYWxscy5wdXNoKCBheGlvcy5nZXQoR1JBRkFOQV9FTkRQT0lOVCArICcvYXBpL29yZ3MvbmFtZS8nICsgb3JnLCB7aGVhZGVyczogeydBdXRob3JpemF0aW9uJzogR1JBRkFOQV9BVVRIfX0pCiAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ09yZ2FuaXphdGlvbiAnICsgb3JnICsgJyBhbHJlYWR5IGV4aXN0cyBpbiBHcmFmYW5hLicsIHJlcyk7CiAgICAgICAgICAgIG9yZ0lkID0gcmVzLmRhdGEuaWQ7ICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIm9yZ2FuaXphdGlvbiBJZDogIiArIG9yZ0lkKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIGFzc2lnbiB0aGUgcHJvcGVyIHJvbGUgdG8gdGhlIHVzZXIgaW5zaWRlIHRoZSBvcmdhbml6YXRpb24KICAgICAgICAgICAgaGFuZGxlVXNlclJvbGVzKGNvbnRleHQsIG9yZ0lkLCB1c2VybmFtZSwgdXNlcklkLCByb2xlKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgcmV0dXJuIGF4aW9zLnBvc3QoR1JBRkFOQV9FTkRQT0lOVCArICcvYXBpL29yZ3MnLCB7bmFtZTogb3JnfSwge2hlYWRlcnM6IHsnQXV0aG9yaXphdGlvbic6IEdSQUZBTkFfQVVUSH19KQogICAgICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ09yZ2FuaXphdGlvbiBkb2VzIG5vdCBleGlzdCBpbiBHcmFmYW5hLkNyZWF0aW5nIG9yZ2FuaXphdGlvbjogJyArIG9yZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmdJZCA9IHJlcy5kYXRhLm9yZ0lkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygib3JnYW5pemF0aW9uIElkOiAiICsgb3JnSWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhc3NpZ24gdGhlIHByb3BlciByb2xlIHRvIHRoZSB1c2VyIGluc2lkZSB0aGUgb3JnYW5pemF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVVc2VyUm9sZXMoY29udGV4dCwgb3JnSWQsIHVzZXJuYW1lLCB1c2VySWQsIHJvbGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JnX2NhbGxzLnB1c2goJ09yZ2FuaXphdGlvbiBkb2VzIG5vdCBleGlzdCBpbiBHcmFmYW5hLkNyZWF0aW5nIG9yZ2FuaXphdGlvbjogJyArIG9yZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ09yZ2FuaXphdGlvbiBkb2VzIG5vdCBleGlzdCBpbiBHcmFmYW5hLkNyZWF0aW5nIG9yZ2FuaXphdGlvbjogJyArIG9yZzsKICAgICAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdFcnJvciB3aGlsZSBjcmVhdGluZyBvcmdhbml6YXRpb246ICcgKyBvcmcgKyAiICIgKyBlcnIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjayhuZXcgY29udGV4dC5SZXNwb25zZSh7bWVzc2FnZTogJ0dSQUZBTkEgY2FsbCBmYWlsdXJlOiAnICsgJ0Vycm9yIHdoaWxlIGNyZWF0aW5nIG9yZ2FuaXphdGlvbjogJyArIG9yZyArICIgIiwgZXJyOiBlcnJ9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA1MDApKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOyAKICAgICAgICB9KQogICAgKTsKICAgIHJldHVybiBvcmdfY2FsbHM7ICAgIAp9OwovKioKICogQ3JlYXRlIHRoZSBnbG9iYWwgdXNlciAKICovCnZhciBwcm92aXNpb25FbnRpdGllcyA9IGFzeW5jIChjb250ZXh0LCBuYW1lLCB1c2VyZW1haWwsIHJvbGVzKSA9PiB7CiAgICB2YXIgcGFzc3cgPSByYW5kb21TdHIuZ2VuZXJhdGUoOCk7CiAgICB2YXIgb2JqVG9CZVNlbnQgPSB7bmFtZSA6IG5hbWUsIGVtYWlsIDogdXNlcmVtYWlsLCBwYXNzd29yZCA6IEdSQUZBTkFfVVNFUl9QQVNTV19ERUZBVUxUfTsKICAgIHZhciB1c2VySWQgPSAwOwogICAgY29udGV4dC5sb2dnZXIuaW5mb1dpdGgoIkhhbmRsaW5nIFVzZXIgY3JlYXRpb246IiArIG5hbWUgKyAiIHdpdGggdXNlcm5hbWU6ICIgKyB1c2VyZW1haWwpOwogICAgdXNlcklkID0gYXdhaXQgYXhpb3MuZ2V0KEdSQUZBTkFfRU5EUE9JTlQgKyAnL2FwaS91c2Vycy9sb29rdXA/bG9naW5PckVtYWlsPScgKyB1c2VyZW1haWwsIHtoZWFkZXJzOiB7J0F1dGhvcml6YXRpb24nOiBHUkFGQU5BX0FVVEh9fSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXMpewogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdHbG9iYWwgdXNlciAnICsgbmFtZSArICcgJyArIHVzZXJlbWFpbCArICcgYWxyZWFkeSBleGlzdHMgaW4gR3JhZmFuYS4nLCByZXMpOwogICAgICAgICAgICB1c2VySWQgPSByZXMuZGF0YS5pZDsKICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSB1c2VyIGZyb20gb2xkIG9yZ3MKICAgICAgICAgICAgcmVtb3ZlVXNlckZyb21PcmcoY29udGV4dCwgdXNlcklkLCByb2xlcyk7CiAgICAgICAgICAgIC8vIHByb3Zpc2lvbmluZyBvcmdhbml6YXRpb25zCiAgICAgICAgICAgIGZvciAodmFyIG9yZyBpbiByb2xlcykgewogICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnSW5zaWRlIGxvb3Agb2Ygb3JncyA6ICcgKyBvcmcgKyAiICIgKyByb2xlc1tvcmddKTsKICAgICAgICAgICAgICAgIHJvbGVOYW1lID0gcm9sZXNbb3JnXTsKICAgICAgICAgICAgICAgIGhhbmRsZU9yZ2FuaXphdGlvbnMoY29udGV4dCwgb3JnLCByb2xlTmFtZSwgdXNlcmVtYWlsLCB1c2VySWQpOwogICAgICAgICAgICB9ICAgICAgICAgCiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgYXhpb3MucG9zdChHUkFGQU5BX0VORFBPSU5UICsgJy9hcGkvYWRtaW4vdXNlcnMnLCBvYmpUb0JlU2VudCwge2hlYWRlcnM6IHsnQXV0aG9yaXphdGlvbic6IEdSQUZBTkFfQVVUSH19KQogICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnVXNlciAnICsgbmFtZSArICcgc3VjY2Vzc2Z1bGx5IGNyZWF0ZWQgaW4gR3JhZmFuYS4nKTsKICAgICAgICAgICAgICAgICAgICB1c2VySWQgPSByZXMuZGF0YS5pZDsKICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIHVzZXIgZnJvbSBvbGQgb3JncwogICAgICAgICAgICAgICAgICAgIHJlbW92ZVVzZXJGcm9tT3JnKGNvbnRleHQsIHVzZXJJZCwgcm9sZXMpOwogICAgICAgICAgICAgICAgICAgIC8vIHByb3Zpc2lvbmluZyBvcmdhbml6YXRpb25zCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgb3JnIGluIHJvbGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ0luc2lkZSBsb29wIG9mIG9yZ3MgOiAnICsgb3JnICsgIiAiICsgcm9sZXNbb3JnXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvbGVOYW1lID0gcm9sZXNbb3JnXTsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlT3JnYW5pemF0aW9ucyhjb250ZXh0LCBvcmcsIHJvbGVOYW1lLCB1c2VyZW1haWwsIHVzZXJJZCk7CiAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLmRhdGEuaWQ7CiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnRXJyb3Igd2hpbGUgY3JlYXRpbmcgdXNlcjogJyArIG5hbWUgKyBlcnIpOwogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmNhbGxiYWNrKG5ldyBjb250ZXh0LlJlc3BvbnNlKHttZXNzYWdlOiAnR1JBRkFOQSBjYWxsIGZhaWx1cmU6ICcgKyAnRXJyb3Igd2hpbGUgY3JlYXRpbmcgdXNlcjogJyArIG5hbWUsIGVycjogZXJyfSwge30sICdhcHBsaWNhdGlvbi9qc29uJywgNTAwKSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7Cn07Ci8qKgogKiBHZXQgdGhlIGxpc3Qgb2Ygb3JnYW5pemF0aW9ucyBpbiBHcmFmYW5hCiAqLwp2YXIgZ2V0TGlzdE9yZ3NPZlVzZXIgPSBhc3luYyAoY29udGV4dCwgdXNlcklkKSA9PiB7CiAgICByZXR1cm4gYXhpb3MuZ2V0KEdSQUZBTkFfRU5EUE9JTlQgKyAnL2FwaS91c2Vycy8nICsgdXNlcklkICsgJy9vcmdzJywge2hlYWRlcnM6IHsnQXV0aG9yaXphdGlvbic6IEdSQUZBTkFfQVVUSH19KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcyl7CiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIkxpc3Qgb2YgdXNlcidzIG9yZ2FuaXphdGlvbnM6ICIpCiAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcy5kYXRhKQogICAgICAgICAgICByZXR1cm4gcmVzLmRhdGEKICAgICAgICB9KQp9CgovKioKICogUmVtb3ZlIHRoZSB1c2VyIGZyb20gdGhlIG5vbi1iZWxvbmdpbmcgb3JnYW5pemF0aW9ucyAKICovCnZhciByZW1vdmVVc2VyRnJvbU9yZyA9IGFzeW5jIChjb250ZXh0LCB1c2VySWQsIHJvbGVzKSA9PiB7CiAgICBvcmdzID0gYXdhaXQgZ2V0TGlzdE9yZ3NPZlVzZXIoY29udGV4dCwgdXNlcklkKTsKICAgIGNvbnNvbGUubG9nKE9iamVjdC5rZXlzKHJvbGVzKSkKICAgIGV4Y2x1ZGVkT3JncyA9IG9yZ3MuZmlsdGVyKHZhbHVlID0+ICFPYmplY3Qua2V5cyhyb2xlcykuaW5jbHVkZXModmFsdWUubmFtZSkpCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJMaXN0IG9mIG9yZ2FuaXphdGlvbnMgdG8gZGVsZXRlIHRoZSB1c2VyIGZyb206ICIpCiAgICBjb25zb2xlLmxvZyhleGNsdWRlZE9yZ3MpCiAgICBmb3IodmFyIGN1cnJPcmcgaW4gZXhjbHVkZWRPcmdzKXsKICAgICAgICBheGlvcy5kZWxldGUoR1JBRkFOQV9FTkRQT0lOVCArICcvYXBpL29yZ3MvJyArIGV4Y2x1ZGVkT3Jnc1tjdXJyT3JnXVsib3JnSWQiXSArICcvdXNlcnMvJyArIHVzZXJJZCwge2hlYWRlcnM6IHsnQXV0aG9yaXphdGlvbic6IEdSQUZBTkFfQVVUSH19KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcyl7CiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ1VzZXIgJyArIHVzZXJJZCArICcgcmVtb3ZlZCBzdWNjZXNzZnVsbHkgZnJvbSBvcmc6ICcgKyBjdXJyT3JnKTsKICAgICAgICAgICAgcmV0dXJuIHJlcy5kYXRhCiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdHUkFGQU5BIGNhbGwgZmFpbHVyZTogJyArICAnRXJyb3Igd2hpbGUgcmVtb3ZpbmcgdXNlciBmcm9tIE9yZy4nICsgY3Vyck9yZy5uYW1lICwgZXJyOiBlcnJ9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA1MDApKTsKICAgICAgICB9KQogICAgfSAgIAp9CgovKioKICogIEFzc2lnbiB0aGUgdXNlciB0byB0aGUgcHJvcGVyIHJvbGUgKEFkbWluLCBFZGl0b3IsIFZpZXdlcikKICovCnZhciBoYW5kbGVVc2VyUm9sZXMgPSBhc3luYyAoY29udGV4dCwgb3JnSWQsIHVzZXJuYW1lLCB1c2VySWQsIHJvbGVOYW1lKSA9PiB7CiAgICB2YXIgb2JqVG9CZVNlbnQgPSB7bG9naW5PckVtYWlsIDogdXNlcm5hbWUsICJyb2xlIiA6IHJvbGVOYW1lfTsKICAgIGNvbnRleHQubG9nZ2VyLmluZm9XaXRoKCJIYW5kbGluZyBSb2xlcyBvZiB1c2VyOiIgKyB1c2VybmFtZSArICIgaW4gb3JnYW5pemF0aW9uSWQuICIgKyBvcmdJZCArICIuIG9ialRvQmVTZW50ICIgLCBvYmpUb0JlU2VudCk7CiAgICBheGlvcy5wb3N0KEdSQUZBTkFfRU5EUE9JTlQgKyAnL2FwaS9vcmdzLycgKyBvcmdJZCArICcvdXNlcnMnLCBvYmpUb0JlU2VudCwge2hlYWRlcnM6IHsnQXV0aG9yaXphdGlvbic6IEdSQUZBTkFfQVVUSH19KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdSb2xlICcgKyByb2xlTmFtZSArICcgc3VjY2Vzc2Z1bGx5IGFzc2lnbmVkIHRvIHVzZXI6ICcgKyB1c2VybmFtZSk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdVc2VyIGlzIGFscmVhZHkgbWVtYmVyIG9mIHRoaXMgb3JnYW5pemF0aW9uLiBTZXR0aW5nIHRoZSBuZXcgcm9sZSB0byB0aGUgb3JnYW5pemF0aW9uICcgKyBvcmdJZCk7CiAgICAgICAgICAgICAgICBvYmpUb0JlU2VudCA9IHsicm9sZSIgOiByb2xlTmFtZX07CiAgICAgICAgICAgICAgICBheGlvcy5wYXRjaChHUkFGQU5BX0VORFBPSU5UICsgJy9hcGkvb3Jncy8nICsgb3JnSWQgKyAnL3VzZXJzLycgKyB1c2VySWQsIG9ialRvQmVTZW50LCB7aGVhZGVyczogeydBdXRob3JpemF0aW9uJzogR1JBRkFOQV9BVVRIfX0pCiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKXsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnUm9sZSAnICsgcm9sZU5hbWUgKyAnIHN1Y2Nlc3NmdWxseSBhc3NpZ25lZCB0byB1c2VyOiAnICsgdXNlcm5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0pIC5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjayhuZXcgY29udGV4dC5SZXNwb25zZSh7bWVzc2FnZTogJ0dSQUZBTkEgY2FsbCBmYWlsdXJlOiAnICsgICdFcnJvciB3aGlsZSBhc3NpZ25pbmcgcm9sZSAnICsgcm9sZU5hbWUgKyAnIHRvIHVzZXI6ICcgKyB1c2VybmFtZSwgZXJyOiBlcnJ9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA1MDApKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9KTsKfTsKZXhwb3J0cy5oYW5kbGVyID0gYXN5bmMoY29udGV4dCwgZXZlbnQpID0+IHsKICAgIGV4dHJhY3RDbGFpbXMoY29udGV4dCwgZXZlbnQuaGVhZGVycywgZnVuY3Rpb24oY2xhaW1zKSB7CiAgICAgICAgdHJ5ewogICAgICAgICAgICAvLyBleHRyYWN0IHJvbGVzCiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm9XaXRoKCdSb2xlcyBmcm9tIEFBQyBmb3IgR3JhZmFuYTogJywgY2xhaW1zW0NVU1RPTUNMQUlNX1JPTEVTXSk7CiAgICAgICAgICAgIHZhciBuYW1lICA9IGNsYWltcy51c2VybmFtZTsKICAgICAgICAgICAgdmFyIHVzZXJuYW1lID0gY2xhaW1zLmVtYWlsOyAgCiAgICAgICAgICAgIHZhciByb2xlcyA9IGNsYWltc1tDVVNUT01DTEFJTV9ST0xFU107ICAgICAgIAogICAgICAgICAgICBpZihyb2xlcyAhPSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgLy8gY3JlYXRlIHRoZSBnbG9iYWwgdXNlciwgdGhlIG9yZ2FuaXphdGlvbnMgYW5kIGFzc2luZyB0aGUgcHJvcGVyIHJvbGVzIHRvIHRoZSB1c2VyCiAgICAgICAgICAgICAgICBwcm92aXNpb25FbnRpdGllcyhjb250ZXh0LCBuYW1lLCB1c2VybmFtZSwgcm9sZXMpOwogICAgICAgICAgICAgICAgY29udGV4dC5jYWxsYmFjayhyb2xlcyk7CiAgICAgICAgICAgIH0gZWxzZXsKICAgICAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdNaXNzaW5nIHJvbGVzIGZyb20gQUFDLiBDaGVjayB0aGUgY2xhaW0gbWFwcGluZyd9LCB7fSwgJ2FwcGxpY2F0aW9uL2pzb24nLCA1MDApKTsKICAgICAgICAgICAgfSAKICAgICAgICB9IGNhdGNoKGVycil7CiAgICAgICAgICAgIGNvbnRleHQuY2FsbGJhY2sobmV3IGNvbnRleHQuUmVzcG9uc2Uoe21lc3NhZ2U6ICdHUkFGQU5BIGNhbGwgZmFpbHVyZScsIGVycjogZXJyfSwge30sICdhcHBsaWNhdGlvbi9qc29uJywgNTAwKSk7CiAgICAgICAgfSAgICAgIAogICAgfSk7Cn07Cg==
    registry: scltestacr.azurecr.io
    runtimeAttributes:
      repositories: []
    timestamp: 1593677600
  description: Provision Users,Organizations, Roles for Grafana
  env:
  - name: AACJWKURL
    value: https://aac.kube-test.smartcommunitylab.it/jwk
  - name: AACRESOURCEID
    value: 3ee98780-48c2-4cea-bf9d-c8bdb5855599
  - name: GRAFANAAUTH
    value: Basic YWRtaW46V2J2OWFweENIYTF1RGRmb1BNWTk=
  - name: GRAFANAENDPOINT
    value: https://grafana.kube-test.smartcommunitylab.it
  eventTimeout: ""
  handler: main:handler
  image: scltestacr.azurecr.io/nuclio-sys-processor:latest
  imageHash: "1593677549308974671"
  imagePullSecrets: registry-credentials
  loggerSinks:
  - level: debug
  maxReplicas: 1
  minReplicas: 1
  platform: {}
  readinessTimeoutSeconds: 60
  resources: {}
  runRegistry: scltestacr.azurecr.io
  runtime: nodejs
  serviceType: NodePort
  targetCPU: 75
  version: -1
status:
  httpPort: 30010
  scaleToZero:
    lastScaleEvent: resourceUpdated
    lastScaleEventTime: "2020-07-02T08:13:30.847575204Z"
  state: ready
